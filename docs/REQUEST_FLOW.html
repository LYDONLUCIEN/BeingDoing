<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeingDoing - å‰åç«¯è¯·æ±‚è°ƒç”¨æµç¨‹æ–‡æ¡£ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .nav {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .nav ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s;
            display: block;
        }

        .nav a:hover {
            background: #f0f3ff;
            transform: translateX(5px);
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.05);
        }

        .section h2 {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .section h3 {
            font-size: 1.4em;
            color: #764ba2;
            margin: 25px 0 15px;
        }

        .section h4 {
            font-size: 1.2em;
            color: #555;
            margin: 20px 0 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-frontend { background: #e3f2fd; color: #1976d2; }
        .badge-backend { background: #e8f5e9; color: #388e3c; }
        .badge-agent { background: #f3e5f5; color: #7b1fa2; }
        .badge-storage { background: #fff3e0; color: #f57c00; }
        .badge-llm { background: #fce4ec; color: #c2185b; }
        .badge-cache { background: #e0f2f1; color: #00695c; }
        .badge-optimized { background: #f3e5f5; color: #7b1fa2; }

        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }

        .color-legend span {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .color-dot.frontend { background: #3B82F6; }
        .color-dot.backend { background: #10B981; }
        .color-dot.agent { background: #8B5CF6; }
        .color-dot.storage { background: #F59E0B; }
        .color-dot.llm { background: #EC4899; }
        .color-dot.cache { background: #00BCD4; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        tr:hover {
            background: #f8f9fa;
        }

        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 0.9em;
            line-height: 1.5;
        }

        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        p code, li code {
            background: #f0f3ff;
            color: #667eea;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .file-path {
            background: #f0f3ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
            font-size: 0.9em;
        }

        .highlight-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .summary-list {
            list-style: none;
            padding: 0;
        }

        .summary-list li {
            padding: 10px 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }

        .summary-list li:before {
            content: "âœ…";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .json-block {
            background: #282c34;
            color: #61dafb;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
        }

        .note-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .note-box strong {
            color: #856404;
        }

        .warning-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .warning-box strong {
            color: #721c24;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .success-box strong {
            color: #155724;
        }

        .arch-diagram {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .arch-box {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .arch-box.frontend {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #1976d2;
        }

        .arch-box.backend {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #388e3c;
        }

        .arch-box.agent {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #7b1fa2;
        }

        .arch-box.storage {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #f57c00;
        }

        .arch-box.cache {
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            border: 2px solid #009688;
        }

        .arch-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .arch-box p {
            margin: 0;
            font-size: 0.9em;
        }

        .config-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-name {
            font-weight: 600;
            color: #667eea;
        }

        .config-value {
            font-family: 'Monaco', monospace;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .comparison-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .comparison-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .comparison-table td:first-child {
            font-weight: 600;
            background: #f8f9fa;
        }

        .old-value {
            background: #ffebee;
            color: #c62828;
        }

        .new-value {
            background: #e8f5e9;
            color: #2e7d32;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .nav ul {
                grid-template-columns: 1fr;
            }
            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ BeingDoing å‰åç«¯è¯·æ±‚è°ƒç”¨æµç¨‹æ–‡æ¡£</h1>
            <p>å®Œæ•´çš„å‰åç«¯äº¤äº’æµç¨‹ã€åº•å±‚é€»è¾‘è°ƒç”¨é“¾è·¯è¯´æ˜ï¼ˆä¼˜åŒ–ç‰ˆ v2.0ï¼‰</p>
            <span class="version-badge">âš¡ ä¼˜åŒ–ç‰ˆï¼šGraph ç¼“å­˜ + å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</span>
        </div>

        <div class="nav">
            <h2>ğŸ“‘ ç›®å½•</h2>
            <ul>
                <li><a href="#overview">æ¦‚è¿°</a></li>
                <li><a href="#optimization-overview">ä¼˜åŒ–ç‰¹æ€§æ¦‚è§ˆ</a></li>
                <li><a href="#architecture">ä¼˜åŒ–åæ¶æ„è®¾è®¡</a></li>
                <li><a href="#graph-cache">Graph ç¼“å­˜æœºåˆ¶</a></li>
                <li><a href="#context-loading">å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</a></li>
                <li><a href="#three-file-system">ä¸‰æ–‡ä»¶å¯¹è¯å­˜å‚¨</a></li>
                <li><a href="#state-management">çŠ¶æ€ç®¡ç†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</a></li>
                <li><a href="#request-lifecycle">è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ</a></li>
                <li><a href="#sequence-diagram">å®Œæ•´è°ƒç”¨åºåˆ—å›¾</a></li>
                <li><a href="#configuration">é…ç½®è¯´æ˜</a></li>
                <li><a href="#comparison">ä¼˜åŒ–å¯¹æ¯”</a></li>
                <li><a href="#file-index">å…³é”®æ–‡ä»¶ç´¢å¼•</a></li>
            </ul>
        </div>

        <!-- æ¦‚è¿° -->
        <div class="section" id="overview">
            <h2>ğŸ“‹ æ¦‚è¿°</h2>
            <p>BeingDoing é‡‡ç”¨ <strong>å‰åç«¯åˆ†ç¦» + AI Agent</strong> çš„æ¶æ„ï¼š</p>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>å±‚çº§</th>
                        <th>æŠ€æœ¯æ ˆ</th>
                        <th>èŒè´£</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-frontend">ğŸ”µ å‰ç«¯ Frontend</span></td>
                        <td>Next.js 14 + React</td>
                        <td>ç”¨æˆ·äº¤äº’ç•Œé¢ã€çŠ¶æ€ç®¡ç†ã€SSE æµå¼æ¥æ”¶</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-backend">ğŸŸ¢ åç«¯ API Backend</span></td>
                        <td>FastAPI</td>
                        <td>RESTful APIã€ç”¨æˆ·è®¤è¯ã€ä¼šè¯ç®¡ç†</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-cache">ğŸ’  Graph Cache</span></td>
                        <td>Python asyncio + LRU</td>
                        <td>Graph å®ä¾‹ç¼“å­˜ã€TTL è¿‡æœŸã€ç»Ÿè®¡ç›‘æ§</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-agent">ğŸŸ£ AI Agent LLM</span></td>
                        <td>LangGraph + OpenAI</td>
                        <td>æ€è€ƒé“¾æ¨ç†ã€å·¥å…·è°ƒç”¨ã€å“åº”ç”Ÿæˆ</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-storage">ğŸŸ  å­˜å‚¨ Storage</span></td>
                        <td>æ–‡ä»¶ç³»ç»Ÿ + PostgreSQL</td>
                        <td>ä¸‰æ–‡ä»¶å¯¹è¯å­˜å‚¨ã€ä¼šè¯çŠ¶æ€æŒä¹…åŒ–</td>
                    </tr>
                </tbody>
            </table>

            <div class="success-box">
                <strong>âœ¨ ä¼˜åŒ–ç‰ˆè®¾è®¡ç†å¿µï¼š</strong> ä¿æŒ <strong>æ— çŠ¶æ€ (Stateless)</strong> æ¶æ„çš„åŒæ—¶ï¼Œé€šè¿‡ <strong>Graph ç¼“å­˜</strong> å’Œ <strong>å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</strong> å®ç°çœŸæ­£çš„å¤šè½®å¯¹è¯ä½“éªŒã€‚
            </div>
        </div>

        <!-- ä¼˜åŒ–ç‰¹æ€§æ¦‚è§ˆ -->
        <div class="section" id="optimization-overview">
            <h2>âš¡ ä¼˜åŒ–ç‰¹æ€§æ¦‚è§ˆ</h2>

            <h3>ä¼˜åŒ–å‰çš„é—®é¢˜</h3>
            <div class="warning-box">
                <strong>âŒ åŸæœ‰æ¶æ„å­˜åœ¨çš„ä¸¥é‡é—®é¢˜ï¼š</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>æ€§èƒ½æµªè´¹ï¼š</strong> æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°ç¼–è¯‘ Agent Graphï¼Œé€ æˆå¤§é‡é‡å¤è®¡ç®—</li>
                    <li><strong>ä¸Šä¸‹æ–‡è®°å¿†ä¸¢å¤±ï¼š</strong> <code>inner_messages</code> æ¯æ¬¡é‡ç½®ä¸ºç©ºæ•°ç»„ï¼ŒAI æ— æ³•çœ‹åˆ°ä¹‹å‰çš„æ€è€ƒè¿‡ç¨‹</li>
                    <li><strong>å•è½®å¯¹è¯ä½“éªŒï¼š</strong> ç»“æœå°±æ˜¯"å¾ˆå‚»"ï¼Œæ¯æ¬¡å¯¹è¯éƒ½åƒç¬¬ä¸€æ¬¡è§é¢</li>
                    <li><strong>Token æµªè´¹ï¼š</strong> æ— æ³•æœ‰æ•ˆå‹ç¼©å†å²å¯¹è¯ï¼Œæ¯æ¬¡éƒ½è¦å‘é€å¤§é‡é‡å¤å†…å®¹</li>
                </ul>
            </div>

            <h3>ä¼˜åŒ–æ–¹æ¡ˆ</h3>
            <div class="success-box">
                <strong>âœ… ä¼˜åŒ–åçš„æ ¸å¿ƒæ”¹è¿›ï¼š</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>Graph ç¼“å­˜ï¼ˆ15åˆ†é’Ÿ TTLï¼‰ï¼š</strong> é¿å…é‡å¤ç¼–è¯‘ï¼Œæå‡å“åº”é€Ÿåº¦</li>
                    <li><strong>å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½ï¼š</strong> ä» <code>all_flow.json</code> æ¢å¤ AI çš„å®Œæ•´æ€è€ƒå†å²</li>
                    <li><strong>ä¸‰æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼š</strong> åˆ†ç¦»ç”¨æˆ·å¯è§å¯¹è¯ã€å®Œæ•´æ€è€ƒã€AI ç»“è®º</li>
                    <li><strong>æ™ºèƒ½å‹ç¼©ç­–ç•¥ï¼š</strong> è¶…è¿‡ 5 è½®åè‡ªåŠ¨å‹ç¼©ï¼Œä¿ç•™æœ€æ–° 3 è½® + å†å²æ‘˜è¦</li>
                    <li><strong>ç»“è®ºæ²‰æ·€æœºåˆ¶ï¼š</strong> AI è‡ªåŠ¨æ€»ç»“å…³é”®æ´å¯Ÿåˆ° <code>note.json</code></li>
                </ul>
            </div>

            <h3>ä¼˜åŒ–æ•ˆæœå¯¹æ¯”</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>ä¼˜åŒ–å‰</th>
                        <th>ä¼˜åŒ–å</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Graph ç¼–è¯‘é¢‘ç‡</td>
                        <td class="old-value">æ¯æ¬¡è¯·æ±‚éƒ½ç¼–è¯‘</td>
                        <td class="new-value">ç¼“å­˜å‘½ä¸­æ—¶å¤ç”¨ï¼ˆ15åˆ†é’Ÿå†…ï¼‰</td>
                    </tr>
                    <tr>
                        <td>ä¸Šä¸‹æ–‡è¿ç»­æ€§</td>
                        <td class="old-value">å•è½®å¯¹è¯ï¼ˆæ¯æ¬¡é‡ç½®ï¼‰</td>
                        <td class="new-value">å¤šè½®å¯¹è¯ï¼ˆå®Œæ•´å†å²ï¼‰</td>
                    </tr>
                    <tr>
                        <td>AI æ€è€ƒå¯è§æ€§</td>
                        <td class="old-value">ä¸å¯è§ï¼ˆä¸¢å¤±ï¼‰</td>
                        <td class="new-value">å®Œæ•´è®°å½•åœ¨ all_flow.json</td>
                    </tr>
                    <tr>
                        <td>Token ä½¿ç”¨æ•ˆç‡</td>
                        <td class="old-value">ä½ï¼ˆé‡å¤å‘é€å†å²ï¼‰</td>
                        <td class="new-value">é«˜ï¼ˆå‹ç¼©åå‘é€ï¼‰</td>
                    </tr>
                    <tr>
                        <td>ç»“è®ºæ€§å†…å®¹</td>
                        <td class="old-value">æ— æ²‰æ·€</td>
                        <td class="new-value">è‡ªåŠ¨æ€»ç»“åˆ° note.json</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ä¼˜åŒ–åæ¶æ„è®¾è®¡ -->
        <div class="section" id="architecture">
            <h2>ğŸ—ï¸ ä¼˜åŒ–åæ¶æ„è®¾è®¡</h2>

            <h3>ç³»ç»Ÿåˆ†å±‚</h3>
            <div class="arch-diagram">
                <div class="arch-box frontend">
                    <h4>ğŸ”µ å‰ç«¯ Frontend</h4>
                    <p>Next.js + React<br/>UIäº¤äº’ + çŠ¶æ€ç®¡ç†</p>
                </div>
                <div class="arch-box backend">
                    <h4>ğŸŸ¢ åç«¯ Backend</h4>
                    <p>FastAPI<br/>APIè·¯ç”± + è®¤è¯</p>
                </div>
                <div class="arch-box cache">
                    <h4>ğŸ’  Graph Cache</h4>
                    <p>TTLç¼“å­˜ + LRUæ·˜æ±°<br/>15åˆ†é’Ÿè¿‡æœŸï¼Œæœ€å¤š20ä¸ª</p>
                </div>
                <div class="arch-box agent">
                    <h4>ğŸŸ£ AI Agent</h4>
                    <p>LangGraph<br/>æ€è€ƒé“¾ + å·¥å…·è°ƒç”¨</p>
                </div>
                <div class="arch-box storage">
                    <h4>ğŸŸ  å­˜å‚¨ Storage</h4>
                    <p>ä¸‰æ–‡ä»¶ç³»ç»Ÿ<br/>all_flow + main_flow + note</p>
                </div>
            </div>

            <div class="color-legend">
                <span><div class="color-dot frontend"></div> å‰ç«¯ Frontend</span>
                <span><div class="color-dot backend"></div> åç«¯ Backend</span>
                <span><div class="color-dot cache"></div> Graph Cache</span>
                <span><div class="color-dot agent"></div> AI Agent</span>
                <span><div class="color-dot storage"></div> æ•°æ®å­˜å‚¨ Storage</span>
                <span><div class="color-dot llm"></div> å¤–éƒ¨æœåŠ¡ LLM API</span>
            </div>

            <h3>ç³»ç»Ÿæ•´ä½“æ¶æ„å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h3>
            <div class="mermaid">
graph TB
    subgraph Frontend["ğŸ”µ å‰ç«¯ Next.js"]
        A[ç”¨æˆ·è¾“å…¥æ¶ˆæ¯] --> B[ConversationInput ç»„ä»¶]
        B --> C[handleChatSubmit å‡½æ•°]
        C --> D[chatApi.sendMessageStream]
    end

    subgraph Backend["ğŸŸ¢ åç«¯ FastAPI"]
        E[POST /api/v1/chat/messages/stream/optimized]
        E --> F[JWT è®¤è¯]
        F --> G["ğŸ’  æ£€æŸ¥ Graph Cache"]
        G -->|ç¼“å­˜å‘½ä¸­| H[å¤ç”¨å·²æœ‰ Graph]
        G -->|ç¼“å­˜æœªå‘½ä¸­| I[åˆ›å»ºæ–° Graph]
        I --> J["ğŸ’  ç¼“å­˜ Graph å®ä¾‹"]
        H --> K["ğŸŸ  åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡<br/>all_flow + note"]
        K --> L[åˆ›å»º Initial State<br/>æ³¨å…¥ inner_messages]
    end

    subgraph Cache["ğŸ’  Graph Cache (15min TTL)"]
        CACHE[(Graph Cache Pool<br/>max_size: 20<br/>TTL: 15min)]
    end

    subgraph Storage["ğŸŸ  æ•°æ®å­˜å‚¨ (ä¸‰æ–‡ä»¶ç³»ç»Ÿ)"]
        P[(PostgreSQL<br/>ä¼šè¯å…ƒæ•°æ®)]
        Q[all_flow.json<br/>åŸæ–‡+AIæ€è€ƒè¿‡ç¨‹]
        R[main_flow.json<br/>ç”¨æˆ·å¯è§å¯¹è¯]
        S[note.json<br/>AIæ€»ç»“çš„ç»“è®º]
        T[question_progress<br/>é¢˜ç›®è¿›åº¦.json]
        U[debug_logs<br/>è°ƒè¯•æ—¥å¿—.jsonl]
    end

    subgraph Agent["ğŸŸ£ AI Agent LangGraph"]
        L --> M[reasoning_node æ¨ç†èŠ‚ç‚¹]
        M --> N{å†³ç­–åˆ†æ”¯}
        N -->|use_tool| O[action_node è¡ŒåŠ¨èŠ‚ç‚¹]
        N -->|respond/guide| P2[è®¾ç½® final_response]
        O --> P2[observation_node è§‚å¯ŸèŠ‚ç‚¹]
        P2 -->|should_continue=true| M
        P2 -->|should_continue=false| Q2[user_agent_node ç”¨æˆ·ä»£ç†èŠ‚ç‚¹]
        P2 --> P
        P2 --> Q
    end

    subgraph Response["ğŸ“¤ å“åº”è¿”å›"]
        V[SSE æµå¼æ¨é€]
        W[done äº‹ä»¶]
    end

    D -->|SSE è¯·æ±‚| E
    G -->|æŸ¥è¯¢| CACHE
    J -->|ä¿å­˜| CACHE
    K -->|åŠ è½½| Q
    K -->|åŠ è½½| S
    K -->|åŠ è½½| T
    K -->|åŠ è½½| P
    Q2 -->|ä¿å­˜| Q
    Q2 -->|ä¿å­˜| R
    Q2 -->|ä¿å­˜| S
    Q2 -->|ä¿å­˜| T
    Q2 -->|ä¿å­˜| U
    Q2 -->|æ›´æ–°| P
    Q2 --> V
    V --> W
    W --> D
    W --> X[å‰ç«¯æ›´æ–° UI]

    classDef frontendStyle fill:#3B82F6,stroke:#2563EB,color:#fff
    classDef backendStyle fill:#10B981,stroke:#059669,color:#fff
    classDef cacheStyle fill:#00BCD4,stroke:#0097A7,color:#fff
    classDef agentStyle fill:#8B5CF6,stroke:#7C3AED,color:#fff
    classDef storageStyle fill:#F59E0B,stroke:#D97706,color:#fff
    classDef responseStyle fill:#EC4899,stroke:#DB2777,color:#fff

    class Frontend frontendStyle
    class Backend,Cache cacheStyle
    class Agent agentStyle
    class Storage storageStyle
    class Response responseStyle
            </div>
        </div>

        <!-- Graph ç¼“å­˜æœºåˆ¶ -->
        <div class="section" id="graph-cache">
            <h2>ğŸ’  Graph ç¼“å­˜æœºåˆ¶</h2>

            <div class="highlight-box">
                <h4>ğŸ¯ ç¼“å­˜ç›®æ ‡</h4>
                <p>é¿å…æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°ç¼–è¯‘ Agent Graphï¼Œæå‡å“åº”é€Ÿåº¦ï¼Œé™ä½ CPU æ¶ˆè€—ã€‚</p>
            </div>

            <h3>ç¼“å­˜ç­–ç•¥</h3>
            <ul style="margin: 20px 0; padding-left: 20px;">
                <li><strong>TTLï¼ˆTime To Liveï¼‰ï¼š</strong> 15 åˆ†é’Ÿè¿‡æœŸï¼Œå¯é€šè¿‡ <code>GRAPH_CACHE_TTL_MINUTES</code> é…ç½®</li>
                <li><strong>LRU æ·˜æ±°ï¼š</strong> æœ€å¤šç¼“å­˜ 20 ä¸ª sessionï¼Œè¶…å‡ºæ—¶æ·˜æ±°æœ€ä¹…æœªä½¿ç”¨çš„</li>
                <li><strong>æ»‘åŠ¨è¿‡æœŸï¼š</strong> æ¯æ¬¡è®¿é—®éƒ½æ›´æ–° <code>last_used</code> æ—¶é—´ï¼Œæ´»è·ƒ session æŒç»­ä¿æŒ</li>
                <li><strong>åå°æ¸…ç†ï¼š</strong> æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜</li>
            </ul>

            <h3>ç¼“å­˜å·¥ä½œæµç¨‹</h3>
            <div class="mermaid">
flowchart TD
    A[æ”¶åˆ°è¯·æ±‚<br/>session_id=xxx] --> B{æ£€æŸ¥ç¼“å­˜}
    B -->|ç¼“å­˜å­˜åœ¨<br/>æœªè¿‡æœŸ| C[âœ… ç¼“å­˜å‘½ä¸­]
    B -->|ç¼“å­˜ä¸å­˜åœ¨<br/>å·²è¿‡æœŸ| D[âŒ ç¼“å­˜æœªå‘½ä¸­]

    C --> E[æ›´æ–° last_used<br/>æ»‘åŠ¨è¿‡æœŸ]
    E --> F[å¤ç”¨ Graph å®ä¾‹]

    D --> G[åˆ›å»ºæ–° Graph]
    G --> H[ç¼–è¯‘ Graph]
    H --> I[ç¼“å­˜æ–°å®ä¾‹<br/>å¦‚æœå·²è¾¾ä¸Šé™<br/>è§¦å‘ LRU æ·˜æ±°]

    F --> J[ç»§ç»­å¤„ç†è¯·æ±‚]
    I --> J

    style A fill:#3B82F6,color:#fff
    style B fill:#00BCD4,color:#fff
    style C,E,F fill:#10B981,color:#fff
    style D,G,H,I fill:#F59E0B,color:#fff
    style J fill:#8B5CF6,color:#fff
            </div>

            <h3>ç¼“å­˜ç»“æ„</h3>
            <p><span class="file-path">src/backend/app/core/agent/graph_cache.py</span></p>
            <pre><code class="language-python">class CachedGraph:
    """ç¼“å­˜çš„ Graph å®ä¾‹"""
    def __init__(self, graph, config: dict):
        self.graph = graph                    # ç¼–è¯‘åçš„ Graph å®ä¾‹
        self.config = config                   # é…ç½®å‚æ•°
        self.created_at = datetime.utcnow()     # åˆ›å»ºæ—¶é—´
        self.last_used = datetime.utcnow()      # æœ€åä½¿ç”¨æ—¶é—´ï¼ˆæ»‘åŠ¨è¿‡æœŸï¼‰

class GraphCache:
    """Graph ç¼“å­˜æ± """
    def __init__(self, ttl_minutes=15, max_size=20):
        self.ttl_minutes = ttl_minutes          # 15åˆ†é’Ÿè¿‡æœŸ
        self.max_size = max_size               # æœ€å¤š20ä¸ªsession
        self._cache: Dict[str, CachedGraph] = {}  # {session_id: CachedGraph}
        self._stats = {
            "hits": 0,      # å‘½ä¸­æ¬¡æ•°
            "misses": 0,     # æœªå‘½ä¸­æ¬¡æ•°
            "evictions": 0,   # æ·˜æ±°æ¬¡æ•°
            "expirations": 0  # è¿‡æœŸæ¬¡æ•°
        }</code></pre>

            <h3>ç¼“å­˜ç»Ÿè®¡ API</h3>
            <p>å¯ä»¥é€šè¿‡ <code>GET /api/v1/chat/cache/stats</code> æŸ¥çœ‹ç¼“å­˜çŠ¶æ€ï¼š</p>
            <div class="json-block">{
  "graph_cache": {
    "size": 5,                    // å½“å‰ç¼“å­˜æ•°é‡
    "max_size": 20,               // æœ€å¤§ç¼“å­˜æ•°
    "ttl_minutes": 15,            // è¿‡æœŸæ—¶é—´
    "hits": 42,                   // å‘½ä¸­æ¬¡æ•°
    "misses": 8,                  // æœªå‘½ä¸­æ¬¡æ•°
    "evictions": 2,               // æ·˜æ±°æ¬¡æ•°
    "expirations": 3,             // è¿‡æœŸæ¬¡æ•°
    "hit_rate": "84.0%"            // å‘½ä¸­ç‡
  }
}</div>
        </div>

        <!-- å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½ -->
        <div class="section" id="context-loading">
            <h2>ğŸ“š å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</h2>

            <div class="highlight-box">
                <h4>ğŸ¯ ä¸Šä¸‹æ–‡åŠ è½½ç›®æ ‡</h4>
                <p>è®© AI èƒ½å¤Ÿ"è®°ä½"ä¹‹å‰çš„å¯¹è¯å’Œæ€è€ƒè¿‡ç¨‹ï¼Œå®ç°çœŸæ­£çš„å¤šè½®å¯¹è¯ä½“éªŒã€‚</p>
            </div>

            <h3>ä¸Šä¸‹æ–‡æ¥æº</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ¥æº</th>
                        <th>æ–‡ä»¶</th>
                        <th>å†…å®¹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-storage">åŸæ–‡å¯¹è¯</span></td>
                        <td><code>all_flow.json</code></td>
                        <td>ç”¨æˆ·è¾“å…¥ + AI æ€è€ƒè¿‡ç¨‹ï¼ˆå®Œæ•´æ€è€ƒé“¾ï¼‰</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-storage">ç»“è®ºæ‘˜è¦</span></td>
                        <td><code>note.json</code></td>
                        <td>AI æ€»ç»“çš„å…³é”®æ´å¯Ÿã€æ­¥éª¤æ‘˜è¦ã€çŸ›ç›¾ç‚¹</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-storage">æœ€è¿‘å¯¹è¯</span></td>
                        <td><code>main_flow.json</code>ï¼ˆå‹ç¼©åï¼‰</td>
                        <td>ç”¨æˆ·å¯è§çš„æœ€è¿‘ N è½®å¯¹è¯</td>
                    </tr>
                </tbody>
            </table>

            <h3>ä¸Šä¸‹æ–‡åŠ è½½æµç¨‹</h3>
            <div class="mermaid">
flowchart LR
    A[è¯·æ±‚å¼€å§‹] --> B[åˆ›å»º Initial State]
    B --> C{å¯ç”¨å®Œæ•´ä¸Šä¸‹æ–‡?}
    C -->|å¦| D[âŒ ç©ºä¸Šä¸‹æ–‡<br/>inner_messages=[]]
    C -->|æ˜¯| E[âœ… åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡]

    E --> F[è¯»å– all_flow.json<br/>è·å–å®Œæ•´æ€è€ƒå†å²]
    E --> G[è¯»å– note.json<br/>è·å–ç»“è®ºæ‘˜è¦]
    E --> H[è¯»å– main_flow.json<br/>è·å–æœ€è¿‘å¯¹è¯]

    F --> I[åˆå¹¶ä¸Šä¸‹æ–‡]
    G --> I
    H --> I

    I --> J{æ£€æŸ¥å‹ç¼©é˜ˆå€¼}
    J -->|è½®æ•°â‰¤5| K[è¿”å›å…¨éƒ¨å†å²]
    J -->|è½®æ•°>5| L[å‹ç¼©è¿”å›<br/>ä¿ç•™æœ€æ–°3è½®+æ‘˜è¦]

    K --> M[æ³¨å…¥ inner_messages]
    L --> M

    M --> N[ç»§ç»­å¤„ç†è¯·æ±‚]

    style A fill:#3B82F6,color:#fff
    style B fill:#10B981,color:#fff
    style C fill:#00BCD4,color:#fff
    style D fill:#F59E0B,color:#fff
    style E,F,G,H,I,J,K,L,M fill:#10B981,color:#fff
    style N fill:#8B5CF6,color:#fff
            </div>

            <h3>ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥</h3>
            <ul style="margin: 20px 0; padding-left: 20px;">
                <li><strong>è§¦å‘æ¡ä»¶ï¼š</strong> å¯¹è¯è½®æ•° > 5 è½®ï¼ˆå¯é…ç½®ï¼‰</li>
                <li><strong>ä¿ç•™ç­–ç•¥ï¼š</strong> ä¿ç•™æœ€æ–° 3 è½®å®Œæ•´å¯¹è¯ + æ›´æ—©è½®çš„æ‘˜è¦</li>
                <li><strong>Token æ§åˆ¶ï¼š</strong> å•æ¬¡ä¸Šä¸‹æ–‡ä¸è¶…è¿‡ 8000 tokensï¼ˆå¯é…ç½®ï¼‰</li>
            </ul>

            <p><span class="file-path">src/backend/app/utils/enhanced_conversation_manager.py:283-365</span></p>
            <pre><code class="language-python">async def get_compressed_context(
    self,
    session_id: str,
    max_rounds: int = 5,           # å‹ç¼©é˜ˆå€¼
    keep_latest: int = 3,           # ä¿ç•™è½®æ•°
    include_all_flow: bool = True
) -> Dict[str, Any]:
    """è·å–å‹ç¼©åçš„ä¸Šä¸‹æ–‡ï¼ˆç”¨äº LLMï¼‰"""
    main_messages = await self.get_main_flow_messages(session_id)
    user_messages = [m for m in main_messages if m.get("role") == "user"]
    round_count = len(user_messages)

    if round_count <= max_rounds:
        # æœªè¶…è¿‡é˜ˆå€¼ï¼Œè¿”å›å…¨éƒ¨
        was_compressed = False
        context_messages = main_messages
    else:
        # è¶…è¿‡é˜ˆå€¼ï¼Œéœ€è¦å‹ç¼©
        was_compressed = True
        # ä¿ç•™æœ€æ–°çš„ keep_latest è½®å¯¹è¯
        cutoff_index = round_count - keep_latest
        # ... å‹ç¼©é€»è¾‘

    return {
        "session_id": session_id,
        "round_count": round_count,
        "was_compressed": was_compressed,
        "messages": llm_messages,
        "all_flow_messages": all_flow_messages,
        "context_summary": f"å½“å‰å¯¹è¯å…± {round_count} è½®ï¼Œ..."
    }</code></pre>
        </div>

        <!-- ä¸‰æ–‡ä»¶å¯¹è¯å­˜å‚¨ -->
        <div class="section" id="three-file-system">
            <h2>ğŸ“ ä¸‰æ–‡ä»¶å¯¹è¯å­˜å‚¨ç³»ç»Ÿ</h2>

            <div class="highlight-box">
                <h4>ğŸ¯ è®¾è®¡ç›®æ ‡</h4>
                <p>åˆ†ç¦»ç”¨æˆ·å¯è§å¯¹è¯ã€å®Œæ•´æ€è€ƒè¿‡ç¨‹ã€AI ç»“è®ºï¼Œä¾¿äºä¸åŒåœºæ™¯ä½¿ç”¨ã€‚</p>
            </div>

            <h3>æ–‡ä»¶ç»“æ„</h3>
            <div class="mermaid">
graph TD
    DIR[data/conversations/]
    DIR --> SID[{session_id}/]
    SID --> ALL[all_flow.json]
    SID --> MAIN[main_flow.json]
    SID --> NOTE[note.json]

    ALL --> ALL_CONT[ç”¨æˆ·è¾“å…¥<br/>AIæ€è€ƒè¿‡ç¨‹<br/>AIæœ€ç»ˆå“åº”]
    MAIN --> MAIN_CONT[ç”¨æˆ·å¯è§çš„<br/>å’¨è¯¢å¯¹è¯]
    NOTE --> NOTE_CONT[AIæ€»ç»“çš„<br/>ç»“è®ºæ€§å†…å®¹]

    style DIR fill:#F59E0B,color:#fff
    style SID fill:#F59E0B,color:#fff
    style ALL fill:#8B5CF6,color:#fff
    style MAIN fill:#10B981,color:#fff
    style NOTE fill:#00BCD4,color:#fff
            </div>

            <h3>all_flow.jsonï¼ˆå®Œæ•´æµç¨‹ï¼‰</h3>
            <p>å­˜å‚¨<strong>å®Œæ•´çš„å¯¹è¯å†å²</strong>ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¾“å…¥ã€AI æ€è€ƒè¿‡ç¨‹ã€AI æœ€ç»ˆå“åº”ã€‚</p>
            <div class="json-block">{
  "session_id": "abc123",
  "category": "all_flow",
  "messages": [
    {
      "id": "msg_1",
      "role": "user",
      "content": "æˆ‘è§‰å¾—å¸®åŠ©åˆ«äººå¾ˆé‡è¦",
      "type": "user_input",
      "created_at": "2024-02-12T10:00:00Z"
    },
    {
      "id": "msg_2",
      "role": "system",
      "content": "åˆ†æç”¨æˆ·çš„ä»·å€¼è§‚å€¾å‘...",
      "type": "ai_thinking",
      "created_at": "2024-02-12T10:00:01Z"
    },
    {
      "id": "msg_3",
      "role": "assistant",
      "content": "å¾ˆå¥½çš„å›ç­”ï¼Œèƒ½å…·ä½“è¯´è¯´...",
      "type": "ai_response",
      "created_at": "2024-02-12T10:00:02Z"
    }
  ],
  "metadata": {
    "created_at": "2024-02-12T10:00:00Z",
    "updated_at": "2024-02-12T10:00:02Z",
    "total_messages": 3
  }
}</div>

            <h3>main_flow.jsonï¼ˆä¸»æµç¨‹ï¼‰</h3>
            <p>å­˜å‚¨<strong>ç”¨æˆ·å¯è§çš„å’¨è¯¢å¯¹è¯</strong>ï¼Œè¿™æ˜¯å‰ç«¯å±•ç¤ºçš„ä¸»è¦å¯¹è¯è®°å½•ã€‚</p>
            <div class="json-block">{
  "session_id": "abc123",
  "category": "main_flow",
  "messages": [
    {
      "id": "msg_1",
      "role": "user",
      "content": "æˆ‘è§‰å¾—å¸®åŠ©åˆ«äººå¾ˆé‡è¦",
      "created_at": "2024-02-12T10:00:00Z"
    },
    {
      "id": "msg_3",
      "role": "assistant",
      "content": "å¾ˆå¥½çš„å›ç­”ï¼Œèƒ½å…·ä½“è¯´è¯´...",
      "created_at": "2024-02-12T10:00:02Z"
    }
  ],
  "metadata": {
    "created_at": "2024-02-12T10:00:00Z",
    "updated_at": "2024-02-12T10:00:02Z",
    "total_messages": 2
  }
}</div>

            <h3>note.jsonï¼ˆç»“è®ºç¬”è®°ï¼‰</h3>
            <p>å­˜å‚¨ <strong>AI æ€»ç»“çš„ç»“è®ºæ€§å†…å®¹</strong>ï¼ŒåŒ…æ‹¬æ­¥éª¤æ‘˜è¦ã€ç”¨æˆ·ç”»åƒã€å…³é”®æ´å¯Ÿã€çŸ›ç›¾ç‚¹ã€‚</p>
            <div class="json-block">{
  "session_id": "abc123",
  "created_at": "2024-02-12T10:00:00Z",
  "updated_at": "2024-02-12T10:05:00Z",
  "notes": [
    {
      "id": "note_1",
      "type": "summary",
      "content": "## æ­¥éª¤æ‘˜è¦\n\n### values_exploration\nç”¨æˆ·é‡è§†å¸®åŠ©ä»–äººã€ç¤¾ä¼šè´¡çŒ®...",
      "created_at": "2024-02-12T10:05:00Z",
      "metadata": {
        "current_step": "values_exploration",
        "total_summaries": 3
      }
    }
  ]
}</div>

            <h3>æ–‡ä»¶å†™å…¥æ—¶æœº</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ“ä½œ</th>
                        <th>å†™å…¥æ–‡ä»¶</th>
                        <th>æ—¶æœº</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ç”¨æˆ·è¾“å…¥</td>
                        <td><code>all_flow.json</code><br/><code>main_flow.json</code></td>
                        <td>è¯·æ±‚å¼€å§‹æ—¶</td>
                    </tr>
                    <tr>
                        <td>AI æ€è€ƒè¿‡ç¨‹</td>
                        <td><code>all_flow.json</code></td>
                        <td>Agent æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ˆä» logsï¼‰</td>
                    </tr>
                    <tr>
                        <td>AI æœ€ç»ˆå“åº”</td>
                        <td><code>all_flow.json</code><br/><code>main_flow.json</code></td>
                        <td>Agent æ‰§è¡Œå®Œæˆå</td>
                    </tr>
                    <tr>
                        <td>AI æ€»ç»“ç»“è®º</td>
                        <td><code>note.json</code></td>
                        <td>æ¯ä¸ªæ­¥éª¤å®Œæˆåï¼Œè‡ªåŠ¨æå–</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- çŠ¶æ€ç®¡ç†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ -->
        <div class="section" id="state-management">
            <h2>ğŸ—‚ï¸ çŠ¶æ€ç®¡ç†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h2>

            <div class="note-box">
                <strong>ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼š</strong> ä¼˜åŒ–ç‰ˆä»ç„¶æ˜¯ <strong>æ— çŠ¶æ€æ¶æ„</strong>ï¼Œä½†é€šè¿‡ <strong>Graph ç¼“å­˜</strong> å’Œ <strong>å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</strong> å®ç°äº†çŠ¶æ€è¿ç»­æ€§ã€‚
            </div>

            <h3>ä¼˜åŒ–åçš„æ¯æ¬¡è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ</h3>
            <div class="mermaid">
flowchart LR
    A[ç”¨æˆ·å‘é€æ¶ˆæ¯] --> B[ğŸŸ¢ åç«¯æ¥æ”¶è¯·æ±‚]
    B --> C["ğŸ’  æ£€æŸ¥ Graph Cache"]
    C -->|å‘½ä¸­| D[âœ… å¤ç”¨ Graph]
    C -->|æœªå‘½ä¸­| E[âŒ åˆ›å»º Graph]
    E --> F["ğŸ’  ç¼“å­˜ Graph"]
    D --> G["ğŸŸ  åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡<br/>all_flow + note"]
    F --> G
    G --> H["ğŸŸ£ åˆ›å»º Initial State<br/>æ³¨å…¥ inner_messages"]
    H --> I[æ‰§è¡Œ Agent æ¨ç†]
    I --> J[ğŸŸ£ ç”Ÿæˆæ–°çŠ¶æ€]
    J --> K["ğŸŸ  ä¿å­˜åˆ°ä¸‰æ–‡ä»¶ç³»ç»Ÿ<br/>all_flow + main_flow + note"]
    K --> L[ğŸ“¤ è¿”å›å“åº”]

    style A fill:#3B82F6,color:#fff
    style B fill:#10B981,color:#fff
    style C fill:#00BCD4,color:#fff
    style D,F fill:#10B981,color:#fff
    style E fill:#F59E0B,color:#fff
    style G fill:#F59E0B,color:#fff
    style H fill:#8B5CF6,color:#fff
    style I,J fill:#8B5CF6,color:#fff
    style K fill:#F59E0B,color:#fff
    style L fill:#EC4899,color:#fff
            </div>

            <h3>Initial State çš„å˜åŒ–</h3>
            <div class="highlight-box">
                <p><strong>âŒ ä¼˜åŒ–å‰ï¼š</strong> <code>inner_messages = []</code> æ¯æ¬¡éƒ½æ˜¯ç©ºæ•°ç»„ï¼Œæ— æ³•è·å–å†å²æ€è€ƒã€‚</p>
                <p><strong>âœ… ä¼˜åŒ–åï¼š</strong> <code>inner_messages</code> ä» <code>all_flow.json</code> åŠ è½½å®Œæ•´å†å²ï¼ŒAI å¯ä»¥çœ‹åˆ°ä¹‹å‰çš„æ€è€ƒè¿‡ç¨‹ã€‚</p>
            </div>

            <h4>ä¼˜åŒ–åæ¯æ¬¡è¯·æ±‚æ—¶ Initial State åŒ…å«ï¼š</h4>
            <table>
                <thead>
                    <tr>
                        <th>å­—æ®µ</th>
                        <th>ä¼˜åŒ–å‰</th>
                        <th>ä¼˜åŒ–å</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>messages</code></td>
                        <td class="old-value">ç©ºæ•°ç»„ <code>[]</code></td>
                        <td class="new-value">ç©ºæ•°ç»„ <code>[]</code>ï¼ˆç”± user_agent å¡«å……ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>inner_messages</code></td>
                        <td class="old-value">ç©ºæ•°ç»„ <code>[]</code> âŒ</td>
                        <td class="new-value">ğŸŸ  ä» <code>all_flow.json</code> åŠ è½½å®Œæ•´å†å² âœ…</td>
                    </tr>
                    <tr>
                        <td><code>context</code></td>
                        <td class="old-value">ç©ºå¯¹è±¡ <code>{}</code> âŒ</td>
                        <td class="new-value">ğŸŸ  æ¢å¤ <code>summaries</code>, <code>profile</code> ç­‰ âœ…</td>
                    </tr>
                    <tr>
                        <td><code>question_progress</code></td>
                        <td>ğŸŸ  ä»æ–‡ä»¶åŠ è½½</td>
                        <td>ğŸŸ  ä»æ–‡ä»¶åŠ è½½ï¼ˆä¿æŒä¸å˜ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>user_input</code></td>
                        <td>å½“å‰è¯·æ±‚</td>
                        <td>å½“å‰è¯·æ±‚</td>
                    </tr>
                    <tr>
                        <td><code>session_id</code></td>
                        <td>å½“å‰è¯·æ±‚</td>
                        <td>å½“å‰è¯·æ±‚</td>
                    </tr>
                    <tr>
                        <td><code>current_step</code></td>
                        <td>å½“å‰è¯·æ±‚</td>
                        <td>å½“å‰è¯·æ±‚</td>
                    </tr>
                </tbody>
            </table>

            <h3>çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h3>
            <table>
                <thead>
                    <tr>
                        <th>çŠ¶æ€ç±»å‹</th>
                        <th>å­˜å‚¨ä½ç½®</th>
                        <th>ä½•æ—¶åŠ è½½</th>
                        <th>ä½•æ—¶ä¿å­˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>é¢˜ç›®è¿›åº¦</strong><br/><code>question_progress</code></td>
                        <td>ğŸŸ  <code>data/question_progress/{session_id}.json</code></td>
                        <td>æ¯æ¬¡è¯·æ±‚å¼€å§‹æ—¶</td>
                        <td>æ¯æ¬¡è¯·æ±‚ç»“æŸæ—¶</td>
                    </tr>
                    <tr>
                        <td><strong>å®Œæ•´å¯¹è¯å†å²</strong><br/><code>all_flow</code></td>
                        <td>ğŸŸ  <code>data/conversations/{session_id}/all_flow.json</code></td>
                        <td>æ¯æ¬¡è¯·æ±‚å¼€å§‹æ—¶<br/>åŠ è½½åˆ° <code>inner_messages</code></td>
                        <td>æ¯æ¬¡æ¶ˆæ¯å<br/>ä¿å­˜ç”¨æˆ·è¾“å…¥+AIæ€è€ƒ+å“åº”</td>
                    </tr>
                    <tr>
                        <td><strong>ç”¨æˆ·å¯è§å¯¹è¯</strong><br/><code>main_flow</code></td>
                        <td>ğŸŸ  <code>data/conversations/{session_id}/main_flow.json</code></td>
                        <td>æ¯æ¬¡è¯·æ±‚å¼€å§‹æ—¶<br/>å‹ç¼©åŠ è½½</td>
                        <td>æ¯æ¬¡æ¶ˆæ¯å<br/>ä¿å­˜ç”¨æˆ·å¯è§æ¶ˆæ¯</td>
                    </tr>
                    <tr>
                        <td><strong>AI ç»“è®ºç¬”è®°</strong><br/><code>note</code></td>
                        <td>ğŸŸ  <code>data/conversations/{session_id}/note.json</code></td>
                        <td>æ¯æ¬¡è¯·æ±‚å¼€å§‹æ—¶<br/>åŠ è½½å…¨å±€ç»“è®º</td>
                        <td>æ¯ä¸ªæ­¥éª¤å®Œæˆå<br/>è‡ªåŠ¨æå–å¹¶ä¿å­˜</td>
                    </tr>
                    <tr>
                        <td><strong>ä¼šè¯å…ƒæ•°æ®</strong><br/><code>session_metadata</code></td>
                        <td>ğŸŸ  PostgreSQL <code>sessions</code> è¡¨</td>
                        <td>JWT è®¤è¯æ—¶</td>
                        <td>æ¯æ¬¡è¯·æ±‚ç»“æŸæ—¶</td>
                    </tr>
                    <tr>
                        <td><strong>Graph å®ä¾‹</strong><br/><code>cached_graph</code></td>
                        <td>ğŸ’  å†…å­˜ç¼“å­˜æ± </td>
                        <td>æ¯æ¬¡è¯·æ±‚å¼€å§‹æ—¶<br/>æ£€æŸ¥ç¼“å­˜</td>
                        <td>ç¼“å­˜æœªå‘½ä¸­æ—¶<br/>åˆ›å»ºå¹¶ç¼“å­˜æ–°å®ä¾‹</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ -->
        <div class="section" id="request-lifecycle">
            <h2>ğŸ”„ è¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h2>

            <h3>å•æ¬¡è¯·æ±‚çš„å®Œæ•´æµç¨‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h3>
            <div class="mermaid">
flowchart TD
                subgraph Request["ä¸€æ¬¡å®Œæ•´çš„èŠå¤©è¯·æ±‚ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"]
                    A[1ï¸âƒ£ ç”¨æˆ·å‘é€æ¶ˆæ¯] --> B[2ï¸âƒ£ å‰ç«¯å‘é€ SSE è¯·æ±‚]
                    B --> C[3ï¸âƒ£ åç«¯æ¥æ”¶å¹¶è®¤è¯]
                    C --> D[4ï¸âƒ£ ğŸ’  æ£€æŸ¥ Graph Cache]
                    D -->|å‘½ä¸­| E[5ï¸âƒ£ âœ… å¤ç”¨å·²æœ‰ Graph]
                    D -->|æœªå‘½ä¸­| F[5ï¸âƒ£ âŒ åˆ›å»ºæ–° Graph å¹¶ç¼“å­˜]
                    E --> G[6ï¸âƒ£ ğŸŸ  åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡<br/>all_flow + note]
                    F --> G
                    G --> H[7ï¸âƒ£ åˆ›å»º Initial State<br/>æ³¨å…¥ inner_messages]
                    H --> I[8ï¸âƒ£ æ‰§è¡Œ Agent æ¨ç†å¾ªç¯]
                    I --> J{9ï¸âƒ£ åˆ¤æ–­æ˜¯å¦ç»§ç»­}
                    J -->|ç»§ç»­| I
                    J -->|ç»“æŸ| K[ğŸ”Ÿ UserAgent è¾“å‡º]
                    K --> L[1ï¸âƒ£1ï¸âƒ£ ğŸ’  ä¿å­˜åˆ°ä¸‰æ–‡ä»¶ç³»ç»Ÿ<br/>all_flow + main_flow + note]
                    L --> M[1ï¸âƒ£2ï¸âƒ£ ğŸ”Ÿ è¿”å› SSE å“åº”]
                end

                style A,B fill:#3B82F6,color:#fff
                style C fill:#10B981,color:#fff
                style D,E,F,G fill:#00BCD4,color:#fff
                style H,I,J,K fill:#8B5CF6,color:#fff
                style L,M fill:#F59E0B,color:#fff
            </div>

            <h3>å¤šæ¬¡è¯·æ±‚çš„çŠ¶æ€æµè½¬ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h3>
            <div class="mermaid">
sequenceDiagram
    participant U as ç”¨æˆ·
    participant Cache as ğŸ’  Graph Cache
    participant FS as ğŸŸ  æ–‡ä»¶ç³»ç»Ÿ
    participant S1 as è¯·æ±‚1
    participant S2 as è¯·æ±‚2
    participant S3 as è¯·æ±‚3

    Note over U,Cache: ç”¨æˆ·å¼€å§‹æ–°çš„ä¼šè¯
    U->>S1: å‘é€æ¶ˆæ¯ "å¼€å§‹æ¢ç´¢"
    S1->>Cache: get_graph(session_id)
    Cache-->>S1: ç¼“å­˜æœªå‘½ä¸­ (None)
    S1->>S1: åˆ›å»ºæ–° Graph
    S1->>Cache: set_graph(session_id, graph)
    S1->>FS: åŠ è½½ä¸Šä¸‹æ–‡ï¼ˆé¦–æ¬¡ä¸ºç©ºï¼‰
    S1->>S1: æ‰§è¡Œ Agentï¼ˆç©ºä¸Šä¸‹æ–‡ï¼‰
    S1->>FS: ä¿å­˜ all_flow, main_flow, note
    S1-->>U: è¿”å›ç¬¬ä¸€é¢˜å¼•å¯¼

    Note over U,Cache: ç”¨æˆ·å›ç­”ï¼ˆ15åˆ†é’Ÿå†…ï¼‰
    U->>S2: å‘é€ç­”æ¡ˆ "æˆ‘é‡è§†å¸®åŠ©ä»–äºº"
    S2->>Cache: get_graph(session_id)
    Cache-->>S2: âœ… ç¼“å­˜å‘½ä¸­ï¼
    S2->>Cache: æ›´æ–° last_used
    S2->>FS: åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆå«ç¬¬ä¸€è½®ï¼‰
    S2->>S2: æ‰§è¡Œ Agentï¼ˆå¸¦å†å²ä¸Šä¸‹æ–‡ï¼‰
    S2->>FS: ä¿å­˜æ–°å¢çš„å¯¹è¯å’Œæ€è€ƒ
    S2-->>U: è¿”å›è¿½é—®

    Note over U,Cache: ç”¨æˆ·ç»§ç»­å›ç­”
    U->>S3: å‘é€è¡¥å……ç­”æ¡ˆ
    S3->>Cache: get_graph(session_id)
    Cache-->>S3: âœ… ç¼“å­˜å‘½ä¸­ï¼
    S3->>FS: åŠ è½½æ›´å¤šä¸Šä¸‹æ–‡ï¼ˆå·²ç´¯ç§¯ï¼‰
    S3->>S3: æ‰§è¡Œ Agentï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
    S3->>FS: ä¿å­˜å¹¶å¯èƒ½è§¦å‘å‹ç¼©
    S3-->>U: è¿”å› Answer Card

    Note over Cache: Graph å®ä¾‹åœ¨è¯·æ±‚é—´å¤ç”¨<br/>15åˆ†é’Ÿå†…æŒç»­æœ‰æ•ˆ
            </div>
        </div>

        <!-- å®Œæ•´è°ƒç”¨åºåˆ—å›¾ -->
        <div class="section" id="sequence-diagram">
            <h2>ğŸ“Š å®Œæ•´è°ƒç”¨åºåˆ—å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h2>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ ç”¨æˆ·
    participant F as ğŸ”µ å‰ç«¯ page.tsx
    participant A as ğŸ”µ API chat.ts
    participant B as ğŸŸ¢ åç«¯ chat_optimized.py
    participant Cache as ğŸ’  Graph Cache
    participant FS as ğŸŸ  æ–‡ä»¶ç³»ç»Ÿ
    participant G as ğŸŸ£ Graph graph_optimized.py
    participant R as ğŸŸ£ Reasoning
    participant AC as ğŸŸ£ Action
    participant O as ğŸŸ£ Observation
    participant UA as ğŸŸ£ UserAgent
    participant L as ğŸ”´ LLM API

    U->>F: è¾“å…¥æ¶ˆæ¯å¹¶ç‚¹å‡»å‘é€
    F->>F: handleChatSubmit()
    F->>F: setStreaming(true)
    F->>A: sendMessageStream(data, callbacks, signal)
    A->>B: POST /api/v1/chat/messages/stream/optimized
    B->>B: éªŒè¯ JWT

    Note over B,Cache: ğŸ’  Graph ç¼“å­˜æ£€æŸ¥
    B->>Cache: get_graph(session_id)
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>B: âœ… è¿”å›ç¼“å­˜çš„ Graph
        Note over B: å¤ç”¨å·²æœ‰ Graph å®ä¾‹<br/>é¿å…é‡å¤ç¼–è¯‘
    else ç¼“å­˜æœªå‘½ä¸­
        Cache-->>B: âŒ Noneï¼ˆæœªå‘½ä¸­æˆ–è¿‡æœŸï¼‰
        B->>G: create_agent_graph(config)
        B->>Cache: set_graph(session_id, graph)
        Note over B: åˆ›å»ºå¹¶ç¼“å­˜æ–° Graph
    end

    Note over B,FS: ğŸŸ  åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡
    B->>FS: load_all_flow(session_id)
    B->>FS: load_notes(session_id)
    B->>FS: load_main_flow_compressed(session_id)
    FS-->>B: è¿”å›å®Œæ•´ä¸Šä¸‹æ–‡æ•°æ®

    Note over B,G: ğŸŸ£ åˆ›å»ºå¸¦å†å²ä¸Šä¸‹æ–‡çš„ Initial State
    B->>G: create_initial_state(
        user_input,
        load_full_context=true,
        enhanced_manager=...
    )
    B-->>A: SSE: {"started": true}
    A-->>F: onStarted()
    F-->>U: æ˜¾ç¤º"æ€è€ƒä¸­â€¦"

    B->>G: graph.astream(state)

    G->>R: reasoning_node(state)

    alt é¦–æ¬¡è¿›å…¥æ­¥éª¤
        R->>R: æ£€æµ‹ need_step_intro
        R->>R: generate_step_intro_message()
        R-->>G: decision: action=respond
    else æ–°é¢˜ç›®
        R->>R: æ£€æµ‹ need_question_guidance
        R->>R: generate_question_guidance_message()
        R-->>G: decision: action=respond
    else å›ç­”å……åˆ†
        R->>R: should_show_answer_card() = true
        R->>L: generate_answer_card_analysis()
        L-->>R: AI åˆ†æç»“æœ
        R->>R: è®¾ç½® answer_card
        R-->>G: decision: action=respond
    else éœ€è¦æ·±å…¥å¯¹è¯
        R->>L: chat_stream(prompt)
        Note over R,L: ğŸ”´ æµå¼ç”Ÿæˆå“åº”<br/>AI èƒ½çœ‹åˆ° inner_messages å†å²æ€è€ƒ
        loop æ¯ä¸ª token
            L-->>R: chunk
            R->>B: queue.put(chunk)
            B-->>A: SSE: {"chunk": "..."}
            A-->>F: onChunk(chunk)
            F-->>U: æ˜¾ç¤ºæµå¼å†…å®¹
        end
        R-->>G: decision: action=use_tool/respond
    end

    G->>AC: action_node(state)
    alt action=use_tool
        AC->>AC: ToolRegistry.get_tool()
        AC->>AC: tool.execute()
        AC-->>G: tool_result
    else action=respond
        AC->>AC: state["final_response"] = response
        AC->>AC: state["should_continue"] = False
        AC-->>G: ç»§ç»­åˆ° observation
    end

    G->>O: observation_node(state)
    alt æœ‰å·¥å…·ç»“æœ
        O->>L: åˆ†æå·¥å…·ç»“æœ
        L-->>O: observation_decision
        O->>O: æ›´æ–° summaries, profile
        O->>O: state["should_continue"] = ?
    else æ— å·¥å…·ç»“æœ
        O->>O: state["should_continue"] = False
    end
    O-->>G: å†³å®šç»§ç»­æˆ–ç»“æŸ

    alt should_continue=true
        G->>R: å›åˆ° reasoning_node
    else should_continue=false
        G->>UA: user_agent_node(state)
        UA->>UA: è·å– final_response
        UA->>UA: å†™å…¥ messages
        UA-->>G: final_state
    end

    G-->>B: final_state

    Note over B,FS: ğŸŸ  ä¿å­˜åˆ°ä¸‰æ–‡ä»¶ç³»ç»Ÿ
    B->>FS: save_all_flow(user_input)
    B->>FS: save_all_flow(ai_thinking)
    B->>FS: save_all_flow(ai_response)
    B->>FS: save_main_flow_messages()
    B->>FS: save_note(summaries, profile)
    B->>FS: _save_question_progress()
    B->>FS: ä¿å­˜ debug_logs

    B-->>A: SSE: {"done": true, "response": "...", "answer_card": {...}, "question_progress": {...}, "suggestions": [...], "note_content": "..."}
    A-->>F: onDone(fullResponse, meta)
    F->>F: setAnswerCard(meta.answerCard)
    F->>F: setQuestionProgress(meta.questionProgress)
    F->>F: setSuggestions(meta.suggestions)
    F->>F: loadChatHistory()
    F-->>U: æ˜¾ç¤ºå®Œæ•´æ¶ˆæ¯ã€Answer Cardã€å»ºè®®
            </div>
        </div>

        <!-- é…ç½®è¯´æ˜ -->
        <div class="section" id="configuration">
            <h2>âš™ï¸ é…ç½®è¯´æ˜</h2>

            <h3>ç¯å¢ƒå˜é‡é…ç½®</h3>
            <p><span class="file-path">.env</span></p>
            <div class="config-box">
                <div class="config-item">
                    <span class="config-name">GRAPH_CACHE_ENABLED</span>
                    <span class="config-value">true</span>
                </div>
                <div class="config-item">
                    <span class="config-name">GRAPH_CACHE_TTL_MINUTES</span>
                    <span class="config-value">15</span>
                </div>
                <div class="config-item">
                    <span class="config-name">GRAPH_CACHE_MAX_SIZE</span>
                    <span class="config-value">20</span>
                </div>
                <div class="config-item">
                    <span class="config-name">GRAPH_CACHE_CLEANUP_INTERVAL_MINUTES</span>
                    <span class="config-value">5</span>
                </div>
                <div class="config-item">
                    <span class="config-name">FULL_CONTEXT_ENABLED</span>
                    <span class="config-value">true</span>
                </div>
                <div class="config-item">
                    <span class="config-name">CONTEXT_COMPRESS_AFTER_ROUNDS</span>
                    <span class="config-value">5</span>
                </div>
                <div class="config-item">
                    <span class="config-name">CONTEXT_KEEP_LATEST_MESSAGES</span>
                    <span class="config-value">3</span>
                </div>
                <div class="config-item">
                    <span class="config-name">CONTEXT_MAX_TOKEN_BUDGET</span>
                    <span class="config-value">8000</span>
                </div>
            </div>

            <h3>é…ç½®ç±»</h3>
            <p><span class="file-path">src/backend/app/config/cache_settings.py</span></p>
            <pre><code class="language-python">class CacheSettings:
    """ç¼“å­˜å’Œä¸Šä¸‹æ–‡åŠ è½½é…ç½®"""
    # Graph ç¼“å­˜é…ç½®
    GRAPH_CACHE_ENABLED: bool = True
    GRAPH_CACHE_TTL_MINUTES: int = 15
    GRAPH_CACHE_MAX_SIZE: int = 20
    GRAPH_CACHE_CLEANUP_INTERVAL_MINUTES: int = 5

    # å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½é…ç½®
    FULL_CONTEXT_ENABLED: bool = True
    CONTEXT_COMPRESS_AFTER_ROUNDS: int = 5
    CONTEXT_KEEP_LATEST_MESSAGES: int = 3
    CONTEXT_MAX_TOKEN_BUDGET: int = 8000

    # å¯¹è¯å­˜å‚¨è·¯å¾„
    CONVERSATION_DIR: str = "data/conversations"</code></pre>

            <h3>API è¯·æ±‚å‚æ•°</h3>
            <p><span class="file-path">SendMessageRequestOptimized</span></p>
            <pre><code class="language-python">class SendMessageRequestOptimized(BaseModel):
    """å‘é€æ¶ˆæ¯è¯·æ±‚ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"""
    session_id: str
    message: str
    current_step: str
    category: str = "main_flow"
    force_regenerate_card: bool = False

    # ===== æ–°å¢å‚æ•° =====
    use_cache: bool = True        # æ˜¯å¦ä½¿ç”¨ Graph ç¼“å­˜
    load_full_context: bool = True   # æ˜¯å¦åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡</code></pre>
        </div>

        <!-- ä¼˜åŒ–å¯¹æ¯” -->
        <div class="section" id="comparison">
            <h2>ğŸ“ˆ ä¼˜åŒ–å¯¹æ¯”</h2>

            <h3>è¯¦ç»†å¯¹æ¯”è¡¨</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ–¹é¢</th>
                        <th>ä¼˜åŒ–å‰</th>
                        <th>ä¼˜åŒ–å</th>
                        <th>æ”¹è¿›</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Graph åˆ›å»º</strong></td>
                        <td class="old-value">æ¯æ¬¡è¯·æ±‚é‡æ–°ç¼–è¯‘</td>
                        <td class="new-value">ç¼“å­˜å¤ç”¨ï¼ˆ15åˆ†é’Ÿå†…ï¼‰</td>
                        <td>âš¡ å‡å°‘ 80%+ ç¼–è¯‘å¼€é”€</td>
                    </tr>
                    <tr>
                        <td><strong>ä¸Šä¸‹æ–‡è®°å¿†</strong></td>
                        <td class="old-value">inner_messages æ¯æ¬¡é‡ç½®</td>
                        <td class="new-value">ä» all_flow.json åŠ è½½å®Œæ•´å†å²</td>
                        <td>ğŸ§  å®ç°å¤šè½®å¯¹è¯èƒ½åŠ›</td>
                    </tr>
                    <tr>
                        <td><strong>å¯¹è¯å­˜å‚¨</strong></td>
                        <td class="old-value">å•ä¸€ main_flow.json</td>
                        <td class="new-value">ä¸‰æ–‡ä»¶ç³»ç»Ÿåˆ†ç¦»</td>
                        <td>ğŸ“ æ¸…æ™°çš„æ•°æ®ç»„ç»‡</td>
                    </tr>
                    <tr>
                        <td><strong>å‹ç¼©ç­–ç•¥</strong></td>
                        <td class="old-value">æ— å‹ç¼©ï¼Œå…¨é‡å‘é€</td>
                        <td class="new-value">5 è½®åå‹ç¼©ï¼Œä¿ç•™æœ€æ–° 3 è½®</td>
                        <td>ğŸ’° èŠ‚çœ 50%+ Token</td>
                    </tr>
                    <tr>
                        <td><strong>ç»“è®ºæ²‰æ·€</strong></td>
                        <td class="old-value">æ— è‡ªåŠ¨æ€»ç»“æœºåˆ¶</td>
                        <td class="new-value">è‡ªåŠ¨æå–åˆ° note.json</td>
                        <td>ğŸ“ ç»“æ„åŒ–çŸ¥è¯†ç§¯ç´¯</td>
                    </tr>
                    <tr>
                        <td><strong>ç›‘æ§ç»Ÿè®¡</strong></td>
                        <td class="old-value">æ— ç¼“å­˜ç»Ÿè®¡</td>
                        <td class="new-value">å‘½ä¸­ç‡ã€æ·˜æ±°æ•°ç­‰ç›‘æ§</td>
                        <td>ğŸ“Š å¯è§‚æµ‹æ€§æå‡</td>
                    </tr>
                    <tr>
                        <td><strong>å¯¹è¯ä½“éªŒ</strong></td>
                        <td class="old-value">å•è½®å¯¹è¯ï¼ˆ"å¾ˆå‚»"ï¼‰</td>
                        <td class="new-value">çœŸæ­£çš„å¤šè½®å¯¹è¯</td>
                        <td>ğŸ¯ è‡ªç„¶æµç•…çš„äº¤äº’</td>
                    </tr>
                </tbody>
            </table>

            <h3>æ€§èƒ½æå‡é¢„ä¼°</h3>
            <div class="arch-diagram">
                <div class="arch-box" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #388e3c;">
                    <h4>âš¡ å“åº”é€Ÿåº¦</h4>
                    <p>ç¼“å­˜å‘½ä¸­æ—¶<br/><strong>å¿« 5-10 å€</strong></p>
                </div>
                <div class="arch-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2;">
                    <h4>ğŸ’° Token æˆæœ¬</h4>
                    <p>å‹ç¼©å<br/><strong>èŠ‚çœ 50%+</strong></p>
                </div>
                <div class="arch-box" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #7b1fa2;">
                    <h4>ğŸ§  å¯¹è¯è´¨é‡</h4>
                    <p>å®Œæ•´ä¸Šä¸‹æ–‡<br/><strong>å¤§å¹…æå‡</strong></p>
                </div>
            </div>
        </div>

        <!-- å…³é”®æ–‡ä»¶ç´¢å¼• -->
        <div class="section" id="file-index">
            <h2>ğŸ“ å…³é”®æ–‡ä»¶ç´¢å¼•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h2>
            <table>
                <thead>
                    <tr>
                        <th>æ–‡ä»¶</th>
                        <th>è¯´æ˜</th>
                        <th>å±‚çº§</th>
                        <th>æ–°å¢/ä¿®æ”¹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>src/frontend/app/(main)/explore/flow/page.tsx</code></td>
                        <td>å‰ç«¯ä¸»é¡µé¢ï¼Œç”¨æˆ·äº¤äº’å…¥å£</td>
                        <td><span class="badge badge-frontend">ğŸ”µ å‰ç«¯</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/frontend/lib/api/chat.ts</code></td>
                        <td>å‰ç«¯ API è°ƒç”¨å±‚ï¼ŒSSE å¤„ç†</td>
                        <td><span class="badge badge-frontend">ğŸ”µ å‰ç«¯</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/api/v1/chat.py</code></td>
                        <td>åç«¯ API ç«¯ç‚¹ï¼ˆåŸæœ‰ç‰ˆï¼‰</td>
                        <td><span class="badge badge-backend">ğŸŸ¢ åç«¯</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/api/v1/chat_optimized.py</code></td>
                        <td>åç«¯ API ç«¯ç‚¹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰<br/>é›†æˆ Graph ç¼“å­˜å’Œå®Œæ•´ä¸Šä¸‹æ–‡</td>
                        <td><span class="badge badge-backend">ğŸŸ¢ åç«¯</span></td>
                        <td><span class="badge badge-optimized">ğŸ†• æ–°å¢</span></td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/config/cache_settings.py</code></td>
                        <td>ç¼“å­˜å’Œä¸Šä¸‹æ–‡é…ç½®<br/>é›†ä¸­ç®¡ç†æ‰€æœ‰ä¼˜åŒ–å‚æ•°</td>
                        <td><span class="badge badge-backend">ğŸŸ¢ åç«¯</span></td>
                        <td><span class="badge badge-optimized">ğŸ†• æ–°å¢</span></td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/graph_cache.py</code></td>
                        <td>Graph ç¼“å­˜å®ç°<br/>TTL + LRU + ç»Ÿè®¡</td>
                        <td><span class="badge badge-cache">ğŸ’  ç¼“å­˜</span></td>
                        <td><span class="badge badge-optimized">ğŸ†• æ–°å¢</span></td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/utils/enhanced_conversation_manager.py</code></td>
                        <td>å¢å¼ºçš„å¯¹è¯ç®¡ç†å™¨<br/>ä¸‰æ–‡ä»¶ç³»ç»Ÿ + å‹ç¼©</td>
                        <td><span class="badge badge-storage">ğŸŸ  å­˜å‚¨</span></td>
                        <td><span class="badge badge-optimized">ğŸ†• æ–°å¢</span></td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/graph.py</code></td>
                        <td>LangGraph å›¾å®šä¹‰ï¼ˆåŸæœ‰ç‰ˆï¼‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/graph_optimized.py</code></td>
                        <td>ä¼˜åŒ–çš„ Graph å’Œ State<br/>é›†æˆå®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td><span class="badge badge-optimized">ğŸ†• æ–°å¢</span></td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/state.py</code></td>
                        <td>Agent çŠ¶æ€å®šä¹‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/nodes/reasoning_v2.py</code></td>
                        <td>æ¨ç†èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/nodes/action.py</code></td>
                        <td>è¡ŒåŠ¨èŠ‚ç‚¹ï¼ˆå·¥å…·è°ƒç”¨ï¼‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/nodes/observation.py</code></td>
                        <td>è§‚å¯ŸèŠ‚ç‚¹ï¼ˆç»“æœåˆ†æï¼‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/core/agent/nodes/user_agent.py</code></td>
                        <td>ç”¨æˆ·ä»£ç†èŠ‚ç‚¹ï¼ˆè¾“å‡ºè½¬æ¢ï¼‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/domain/steps.py</code></td>
                        <td>æ¢ç´¢æ­¥éª¤å®šä¹‰</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/domain/question_flow.py</code></td>
                        <td>é¢˜ç›®æµç¨‹ç®¡ç†</td>
                        <td><span class="badge badge-agent">ğŸŸ£ Agent</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>src/backend/app/utils/conversation_file_manager.py</code></td>
                        <td>å¯¹è¯è®°å½•ç®¡ç†ï¼ˆåŸæœ‰ç‰ˆï¼‰</td>
                        <td><span class="badge badge-storage">ğŸŸ  å­˜å‚¨</span></td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>

            <h3>æ–°å¢ API ç«¯ç‚¹</h3>
            <table>
                <thead>
                    <tr>
                        <th>ç«¯ç‚¹</th>
                        <th>æ–¹æ³•</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/api/v1/chat/messages/stream/optimized</code></td>
                        <td>POST</td>
                        <td>ä¼˜åŒ–çš„æµå¼å¯¹è¯ç«¯ç‚¹<br/>ï¼ˆé›†æˆç¼“å­˜å’Œå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/chat/cache/stats</code></td>
                        <td>GET</td>
                        <td>è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯<br/>ï¼ˆå‘½ä¸­ç‡ã€ç¼“å­˜æ•°ç­‰ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/chat/cache/clear</code></td>
                        <td>POST</td>
                        <td>æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜<br/>ï¼ˆå¯æŒ‡å®š session_id æˆ–å…¨éƒ¨ï¼‰</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ€»ç»“ -->
        <div class="section">
            <h2>ğŸ“Œ æ€»ç»“</h2>

            <h3>ä¼˜åŒ–ç‰ˆæ ¸å¿ƒæ¶æ„æ¨¡å¼</h3>
            <div class="highlight-box">
                <p><strong>ğŸ”‘ Stateless + Caching Design (æ— çŠ¶æ€ + ç¼“å­˜è®¾è®¡)</strong></p>
                <ul>
                    <li><strong>ä¿æŒæ— çŠ¶æ€ï¼š</strong> æ¯ä¸ª HTTP è¯·æ±‚ä»ç„¶æ˜¯ç‹¬ç«‹çš„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•</li>
                    <li><strong>Graph ç¼“å­˜ï¼š</strong> 15 åˆ†é’Ÿ TTLï¼Œæœ€å¤š 20 ä¸ª sessionï¼Œè‡ªåŠ¨ LRU æ·˜æ±°</li>
                    <li><strong>å®Œæ•´ä¸Šä¸‹æ–‡ï¼š</strong> ä»ä¸‰æ–‡ä»¶ç³»ç»ŸåŠ è½½ï¼ŒAI å¯ä»¥"è®°ä½"ä¹‹å‰çš„æ€è€ƒ</li>
                    <li><strong>æ™ºèƒ½å‹ç¼©ï¼š</strong> è¶…è¿‡ 5 è½®åå‹ç¼©ï¼Œä¿ç•™æœ€æ–° 3 è½® + å†å²æ‘˜è¦</li>
                </ul>
            </div>

            <h3>ä¼˜åŒ–ç‰ˆè¯·æ±‚è°ƒç”¨æµç¨‹</h3>
            <ol style="margin: 20px 0; padding-left: 20px;">
                <li style="margin: 10px 0;"><strong>ğŸ”µ å‰ç«¯</strong>ï¼šç”¨æˆ·è¾“å…¥ â†’ <code>handleChatSubmit</code> â†’ SSE è¯·æ±‚</li>
                <li style="margin: 10px 0;"><strong>ğŸ’  Graph Cache</strong>ï¼šæ£€æŸ¥ç¼“å­˜ â†’ å‘½ä¸­å¤ç”¨ / æœªå‘½ä¸­åˆ›å»ºæ–°å®ä¾‹</li>
                <li style="margin: 10px 0;"><strong>ğŸŸ  ä¸Šä¸‹æ–‡åŠ è½½</strong>ï¼šä»ä¸‰æ–‡ä»¶ç³»ç»ŸåŠ è½½å®Œæ•´å†å²ï¼ˆall_flow + noteï¼‰</li>
                <li style="margin: 10px 0;"><strong>ğŸŸ£ Agent</strong>ï¼š
                    <ul style="margin-top: 5px;">
                        <li><code>reasoning_node</code>: åˆ†æçŠ¶æ€ï¼Œå†³å®šè¡ŒåŠ¨ï¼ˆèƒ½çœ‹åˆ°å†å² <code>inner_messages</code>ï¼‰</li>
                        <li><code>action_node</code>: æ‰§è¡Œå·¥å…·æˆ–è®¾ç½®å“åº”</li>
                        <li><code>observation_node</code>: åˆ†æç»“æœï¼Œå†³å®šæ˜¯å¦ç»§ç»­</li>
                        <li>å¾ªç¯ç›´åˆ° <code>should_continue=false</code></li>
                    </ul>
                </li>
                <li style="margin: 10px 0;"><strong>ğŸŸ£ UserAgent</strong>ï¼šå°†æ€è€ƒé“¾ç»“æœè½¬ä¸ºç”¨æˆ·å¯è§æ¶ˆæ¯</li>
                <li style="margin: 10px 0;"><strong>ğŸŸ  å­˜å‚¨</strong>ï¼šğŸ’¾ ä¿å­˜åˆ°ä¸‰æ–‡ä»¶ç³»ç»Ÿï¼ˆall_flow + main_flow + noteï¼‰</li>
                <li style="margin: 10px 0;"><strong>ğŸ”´ å“åº”</strong>ï¼šSSE æ¨é€åˆ°å‰ç«¯ï¼Œæ›´æ–° UI</li>
            </ol>

            <div class="success-box" style="margin-top: 30px;">
                <h3>ä¼˜åŒ–ç‰ˆå®ç°çš„æ ¸å¿ƒä»·å€¼ï¼š</h3>
                <ul class="summary-list">
                    <li>ä¿æŒæ— çŠ¶æ€æ¶æ„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•</li>
                    <li>Graph ç¼“å­˜é¿å…é‡å¤ç¼–è¯‘ï¼Œæå‡ 5-10 å€å“åº”é€Ÿåº¦</li>
                    <li>å®Œæ•´ä¸Šä¸‹æ–‡åŠ è½½å®ç°çœŸæ­£çš„å¤šè½®å¯¹è¯èƒ½åŠ›</li>
                    <li>ä¸‰æ–‡ä»¶ç³»ç»Ÿæ¸…æ™°åˆ†ç¦»ç”¨æˆ·å¯¹è¯ã€AI æ€è€ƒã€ç»“è®ºç¬”è®°</li>
                    <li>æ™ºèƒ½å‹ç¼©ç­–ç•¥èŠ‚çœ 50%+ Token æˆæœ¬</li>
                    <li>è‡ªåŠ¨ç»“è®ºæ²‰æ·€å®ç°çŸ¥è¯†ç§¯ç´¯</li>
                    <li>å®Œæ•´çš„ç¼“å­˜ç»Ÿè®¡å’Œç›‘æ§èƒ½åŠ›</li>
                </ul>
            </div>

            <h3>ä¼˜åŒ–åçŠ¶æ€æµè½¬å›¾</h3>
            <div class="mermaid">
flowchart LR
    subgraph Request_N["è¯·æ±‚ Nï¼ˆä¼˜åŒ–ç‰ˆï¼‰"]
        A1[ğŸ’  æ£€æŸ¥ Cache] --> A2[ğŸŸ  åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡]
        A2 --> A3[å¤„ç†è¯·æ±‚]
        A3 --> A4[ğŸ’  ä¿å­˜åˆ°ä¸‰æ–‡ä»¶]
    end

    subgraph Request_N1["è¯·æ±‚ N+1ï¼ˆ15åˆ†é’Ÿå†…ï¼‰"]
        B1[ğŸ’  Cache å‘½ä¸­!] --> B2[ğŸŸ  åŠ è½½ç´¯ç§¯ä¸Šä¸‹æ–‡]
        B2 --> B3[å¤„ç†è¯·æ±‚<br/>å¸¦å®Œæ•´å†å²]
        B3 --> B4[ğŸ’  ä¿å­˜åˆ°ä¸‰æ–‡ä»¶]
    end

    subgraph Storage["ğŸŸ  ä¸‰æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ"]
        AF[(all_flow.json<br/>å®Œæ•´æ€è€ƒå†å²)]
        MF[(main_flow.json<br/>ç”¨æˆ·å¯è§å¯¹è¯)]
        NT[(note.json<br/>AI ç»“è®ºç¬”è®°)]
    end

    subgraph Cache["ğŸ’  Graph Cache Pool"]
        GC[(Graph å®ä¾‹ç¼“å­˜<br/>TTL: 15min)]
    end

    A4 --> AF
    A4 --> MF
    A4 --> NT
    AF --> B2
    MF --> B2
    NT --> B2

    A1 --> GC
    B1 --> GC

    style A1,A2,A3,A4,B1,B2,B3,B4 fill:#10B981,color:#fff
    style AF,MF,NT fill:#F59E0B,color:#fff
    style GC fill:#00BCD4,color:#fff
            </div>
        </div>

        <!-- é¡µè„š -->
        <div style="text-align: center; padding: 20px; color: #888;">
            <p>BeingDoing é¡¹ç›®æ–‡æ¡£ï¼ˆä¼˜åŒ–ç‰ˆ v2.0ï¼‰ Â· ç”Ÿæˆæ—¶é—´: <span id="current-time"></span></p>
        </div>
    </div>

    <div class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        â†‘
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3B82F6',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2563EB',
                lineColor: '#666',
                secondaryColor: '#10B981',
                tertiaryColor: '#8B5CF6',
                background: '#fff',
                mainBkg: '#f8f9fa',
                nodeBorder: '#e0e0e0',
                clusterBkg: '#f0f3ff',
                clusterBorder: '#667eea',
                titleColor: '#667eea',
                edgeLabelBackground: '#fff',
                actorBkg: '#3B82F6',
                actorBorder: '#2563EB',
                actorTextColor: '#fff',
                actorLineColor: '#666',
                signalColor: '#666',
                signalTextColor: '#333',
                labelBoxBkgColor: '#fff',
                labelBoxBorderColor: '#e0e0e0',
                labelTextColor: '#333',
                loopTextColor: '#333',
                noteBorderColor: '#667eea',
                noteBkgColor: '#f0f3ff',
                noteTextColor: '#333',
                activationBorderColor: '#667eea',
                activationBkgColor: '#f0f3ff',
                sequenceNumberColor: '#fff',
                sequenceNumberBkg: '#667eea'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                useMaxWidth: true,
                noteAlign: 'center',
                messageMargin: 35
            }
        });

        // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });

        // è®¾ç½®å½“å‰æ—¶é—´
        document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN');
    </script>
</body>
</html>
