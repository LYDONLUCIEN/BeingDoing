# 数据库设计

## 一、数据库选择

### 1.1 生产环境
- **数据库**：PostgreSQL 14+
- **优势**：
  - 功能强大
  - 支持JSON字段
  - 良好的并发性能
  - 丰富的扩展

### 1.2 开发环境
- **数据库**：SQLite
- **优势**：
  - 零配置
  - 便于开发测试
  - 文件存储

## 二、数据表设计

### 2.1 用户表 (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    username VARCHAR(100),
    password_hash VARCHAR(255) NOT NULL,  -- 加密后的密码
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
```

**说明**：用户注册登录表，必须

### 2.2 用户信息表 (user_profiles)

```sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    gender VARCHAR(20),  -- male, female, other
    age INTEGER,
    profile_completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

CREATE INDEX idx_profiles_user_id ON user_profiles(user_id);
```

**字段说明**：
- `gender`: 性别
- `age`: 年龄
- `profile_completed`: 是否完成信息收集

### 2.3 工作履历表 (work_history)

```sql
CREATE TABLE work_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    company VARCHAR(255),
    position VARCHAR(255),
    start_date DATE,
    end_date DATE,  -- NULL表示当前工作
    evaluation TEXT,  -- 工作评价和感受
    skills_used TEXT[],  -- 使用的技能数组
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_work_history_user_id ON work_history(user_id);
CREATE INDEX idx_work_history_dates ON work_history(start_date, end_date);
```

**字段说明**：
- `evaluation`: 对这段工作的评价和感受（大量文本输入）
- `skills_used`: 使用的技能列表

### 2.4 项目经历表 (project_experiences)

```sql
CREATE TABLE project_experiences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    work_history_id UUID NOT NULL REFERENCES work_history(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,  -- 项目名称
    description TEXT,  -- 项目描述
    role VARCHAR(255),  -- 担任角色
    achievements TEXT,  -- 成就描述
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_projects_work_history_id ON project_experiences(work_history_id);
```

**字段说明**：
- 关联到工作履历，一个工作可以包含多个项目

### 2.5 会话表 (sessions)

```sql
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,  -- 可选，匿名用户为NULL
    device_id VARCHAR(255),  -- 设备指纹
    current_step VARCHAR(50),  -- 当前步骤: values_exploration, strengths_exploration, interests_exploration, combination, refinement
    status VARCHAR(20) DEFAULT 'active',  -- active, paused, completed
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_sessions_device_id ON sessions(device_id);
CREATE INDEX idx_sessions_status ON sessions(status);
```

**字段说明**：
- `current_step`: 当前探索步骤
- `status`: 会话状态

### 2.6 进度表 (progress)

```sql
CREATE TABLE progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    step VARCHAR(50) NOT NULL,  -- values_exploration, strengths_exploration, interests_exploration
    completed_count INTEGER DEFAULT 0,  -- 已完成问题数
    total_count INTEGER DEFAULT 0,  -- 总问题数
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(session_id, step)
);

CREATE INDEX idx_progress_session_id ON progress(session_id);
CREATE INDEX idx_progress_step ON progress(step);
```

**字段说明**：
- `step`: 探索步骤
- `completed_count`: 已完成问题数
- `total_count`: 总问题数

### 2.7 问题表 (questions)

```sql
CREATE TABLE questions (
    id SERIAL PRIMARY KEY,
    category VARCHAR(20) NOT NULL,  -- values, strengths, interests
    number INTEGER NOT NULL,  -- 问题编号
    title TEXT NOT NULL,  -- 问题标题
    content TEXT NOT NULL,  -- 问题内容
    hints TEXT[],  -- 提示数组
    is_starred BOOLEAN DEFAULT FALSE,  -- 是否带⭐（用于工作目的）
    metadata JSONB,  -- 额外元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(category, number)
);

CREATE INDEX idx_questions_category ON questions(category);
CREATE INDEX idx_questions_starred ON questions(is_starred);
```

**说明**：问题数据可以从question.md解析导入，或直接读取文件

### 2.8 回答表 (answers)

```sql
CREATE TABLE answers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    question_id INTEGER REFERENCES questions(id) ON DELETE SET NULL,
    content TEXT NOT NULL,  -- 用户回答内容
    word_count INTEGER,  -- 字数
    time_spent INTEGER,  -- 花费时间（秒）
    metadata JSONB,  -- 额外元数据（如语音文件路径等）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_answers_session_id ON answers(session_id);
CREATE INDEX idx_answers_question_id ON answers(question_id);
CREATE INDEX idx_answers_created_at ON answers(created_at);
```

**字段说明**：
- `content`: 用户回答的文本内容
- `metadata`: 可存储语音文件、编辑历史等

### 2.9 对话记录（JSON文件存储）

**存储方式**：JSON文件，不存储在数据库表中

**文件结构**：
```
data/
└── conversations/
    └── {session_id}/
        ├── main_flow.json      # 主流程对话
        ├── guidance.json      # 引导对话
        ├── clarification.json  # 澄清对话
        └── other.json         # 其他对话
```

**JSON文件格式**：
```json
{
  "session_id": "uuid",
  "category": "main_flow",  // main_flow, guidance, clarification, other
  "messages": [
    {
      "id": "msg_1",
      "role": "user",  // user, assistant
      "content": "用户消息",
      "context": {
        "current_step": "values_exploration",
        "current_question_id": 1,
        "selected_text": null
      },
      "message_type": "text",  // text, voice
      "related_content": {
        "values": ["发现", "成长"],
        "examples": ["示例1", "示例2"]
      },
      "created_at": "2024-01-01T00:00:00Z"
    },
    {
      "id": "msg_2",
      "role": "assistant",
      "content": "AI回答内容",
      "context": {...},
      "related_content": {...},
      "created_at": "2024-01-01T00:00:01Z"
    }
  ],
  "metadata": {
    "total_messages": 10,
    "last_updated": "2024-01-01T00:00:10Z"
  }
}
```

**对话分类**：
- **main_flow**: 主流程对话（探索过程中的问答）
- **guidance**: 引导对话（主动引导、默认引导问题）
- **clarification**: 澄清对话（概念解释、问题澄清）
- **other**: 其他对话（通用问答等）

**文件管理**：
- 按session_id创建目录
- 按类别分文件存储
- 支持追加写入
- 定期归档（可选）

**优势**：
- 便于查看和读取（JSON格式）
- 适合多轮对话存储
- 分类清晰
- 易于备份和迁移

### 2.10 探索结果表 (exploration_results)

```sql
CREATE TABLE exploration_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    values_selected TEXT[],  -- 选中的价值观列表
    strengths_selected TEXT[],  -- 选中的才能列表
    interests_selected TEXT[],  -- 选中的兴趣列表
    wanted_thing TEXT,  -- 想做的事
    true_wanted_thing TEXT,  -- 真正想做的事
    summary JSONB,  -- 完整摘要
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_results_session_id ON exploration_results(session_id);
```

**字段说明**：
- `values_selected`: 用户最终选择的价值观
- `summary`: 完整的探索摘要（JSON格式）

### 2.11 用户选择表 (user_selections)

```sql
CREATE TABLE user_selections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    category VARCHAR(20) NOT NULL,  -- values, strengths, interests
    selected_items TEXT[] NOT NULL,  -- 选中的项目列表
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, session_id, category)
);

CREATE INDEX idx_selections_user_id ON user_selections(user_id);
CREATE INDEX idx_selections_session_id ON user_selections(session_id);
CREATE INDEX idx_selections_category ON user_selections(category);
```

**字段说明**：
- `category`: 选择类别（价值观、才能、兴趣）
- `selected_items`: 用户选择的项目数组

### 2.12 引导偏好表 (guide_preferences)

```sql
CREATE TABLE guide_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    preference VARCHAR(20) DEFAULT 'normal',  -- normal, quiet
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(session_id)
);

CREATE INDEX idx_guide_prefs_session_id ON guide_preferences(session_id);
```

**字段说明**：
- `preference`: 引导偏好（normal: 10分钟提示，quiet: 15分钟提示）

### 2.13 知识库缓存表 (knowledge_cache) - 可选

```sql
CREATE TABLE knowledge_cache (
    id SERIAL PRIMARY KEY,
    source VARCHAR(100) NOT NULL,  -- 来源: values_csv, strengths_csv, interests_csv, questions_md
    content_key VARCHAR(255) NOT NULL,  -- 内容键
    content_data JSONB NOT NULL,  -- 内容数据
    embedding VECTOR(1536),  -- 向量嵌入（如果使用向量检索）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(source, content_key)
);

CREATE INDEX idx_knowledge_source ON knowledge_cache(source);
-- 如果使用向量检索
CREATE INDEX idx_knowledge_embedding ON knowledge_cache USING ivfflat (embedding vector_cosine_ops);
```

**说明**：用于缓存解析后的CSV和Markdown内容，提高检索速度

## 三、数据关系图

```
users (用户)
  │
  ├─── user_profiles (1:1) - 用户信息
  ├─── work_history (1:N) - 工作履历
  │     └─── project_experiences (1:N) - 项目经历
  ├─── sessions (1:N) - 会话
  │     │
  │     ├─── progress (1:N) - 进度
  │     ├─── answers (1:N) - 回答
  │     ├─── exploration_results (1:1) - 探索结果
  │     ├─── user_selections (1:N) - 用户选择
  │     └─── guide_preferences (1:1) - 引导偏好
  │
  └─── user_selections (1:N) - 用户选择（关联到用户）

questions (独立)
  │
  └─── answers (1:N)

conversations (JSON文件)
  └─── 按session_id和类别存储
        ├── main_flow.json
        ├── guidance.json
        ├── clarification.json
        └── other.json

knowledge_cache (独立，缓存用)
```

## 四、数据初始化

### 4.1 问题数据导入
- 从`question.md`解析90个问题
- 导入到`questions`表

### 4.2 知识库数据导入
- 从CSV文件读取数据
- 可选：生成向量嵌入
- 存储到`knowledge_cache`表

## 五、数据迁移

### 5.1 使用Alembic（SQLAlchemy）
```python
# 创建迁移
alembic revision --autogenerate -m "Initial migration"

# 执行迁移
alembic upgrade head
```

### 5.2 迁移文件示例
```python
# migrations/versions/001_initial.py
def upgrade():
    op.create_table('sessions', ...)
    op.create_table('progress', ...)
    # ...
```

## 六、数据备份

### 6.1 备份策略
- **每日备份**：全量备份
- **实时备份**：WAL归档（PostgreSQL）
- **保留期**：30天

### 6.2 备份命令
```bash
# PostgreSQL
pg_dump -h localhost -U user -d database > backup.sql

# SQLite
cp database.db backup_$(date +%Y%m%d).db
```

## 七、数据隐私

### 7.1 匿名用户数据
- 使用`device_id`标识，不存储个人信息
- 定期清理过期会话（如30天未活动）

### 7.2 注册用户数据
- 加密存储敏感信息
- 支持数据导出和删除

### 7.3 数据保留
- 活跃会话：永久保留（用户可删除）
- 匿名会话：30天未活动自动删除

## 八、性能优化

### 8.1 索引优化
- 所有外键字段建立索引
- 常用查询字段建立索引
- 时间字段建立索引

### 8.2 查询优化
- 使用连接查询减少N+1问题
- 分页查询使用LIMIT/OFFSET
- 大文本字段考虑单独存储

### 8.3 缓存策略
- 问题列表缓存
- 知识库内容缓存
- 会话信息缓存（Redis）
