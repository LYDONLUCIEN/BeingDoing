# 技术架构设计

## 一、整体架构

### 1.1 简化架构（验证阶段，默认）

```
┌─────────────────────────────────────────────────────────┐
│                     用户端 (浏览器)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  前端应用     │  │  移动端适配   │  │  语音输入     │  │
│  │  (React/TS)   │  │  (响应式)     │  │  (可选)       │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │ HTTP/HTTPS
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   后端服务 (FastAPI)                      │
│  ┌──────────────────────────────────────────────────┐  │
│  │  静态文件服务 (内置) + API服务                      │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        ▼                                   ▼
┌──────────────┐                    ┌──────────────┐
│   数据库      │                    │   AI服务      │
│  (SQLite/    │                    │  (LLM/ASR/   │
│   PostgreSQL) │                    │   TTS API)   │
└──────────────┘                    └──────────────┘
        │
        ▼
┌──────────────┐
│   文件存储     │
│  (CSV/知识库)  │
└──────────────┘
```

**特点**：
- 无网关/负载均衡（FastAPI内置静态文件服务）
- 无独立向量数据库（使用内存/文件存储）
- 简单直接，适合验证阶段

### 1.2 完整架构（生产环境，保留接口，暂不开发）

```
┌─────────────────────────────────────────────────────────┐
│                     用户端 (浏览器)                       │
└─────────────────────────────────────────────────────────┘
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    API网关/负载均衡                       │
│              (Nginx / API Gateway)                       │
│              [保留接口，暂不实现]                         │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        ▼                                   ▼
┌──────────────┐                    ┌──────────────┐
│   前端服务     │                    │   后端服务     │
│  (静态资源)    │                    │  (FastAPI)    │
│  (Nginx/CDN)  │                    └──────────────┘
│  [保留接口]    │                            │
└──────────────┘                            │
                    ┌───────────────────────┼───────────────────────┐
                    ▼                       ▼                       ▼
            ┌──────────────┐        ┌──────────────┐        ┌──────────────┐
            │   数据库      │        │   向量数据库   │        │   AI服务      │
            │  (PostgreSQL) │        │  (Chroma/    │        │  (LLM/ASR/   │
            │  [保留接口]   │        │   FAISS)      │        │   TTS API)   │
            │               │        │  [保留接口]   │        │               │
            └──────────────┘        └──────────────┘        └──────────────┘
                    │
                    ▼
            ┌──────────────┐
            │   文件存储     │
            │  (CSV/知识库)  │
            └──────────────┘
```

**特点**：
- 保留接口和设计思路
- 暂不实现，维护接口兼容性
- 未来需要时可快速扩展

### 1.3 架构切换控制

**当前策略**：只实现简化架构，完整架构保留接口

通过全局配置参数控制：

```python
# config/settings.py
ARCHITECTURE_MODE = "simple"  # 当前只支持 "simple"

# 简化架构配置（当前实现）
SIMPLE_ARCH = {
    "use_gateway": False,           # 不使用网关
    "use_vector_db": False,         # 不使用向量数据库
    "use_redis": False,             # 不使用Redis
    "use_celery": False,            # 不使用Celery
    "static_files": "fastapi",      # FastAPI内置静态文件服务
    "vector_store": "memory",       # 内存向量存储
    "cache": "memory",             # 内存缓存
    "database": "sqlite"            # SQLite数据库
}

# 完整架构配置（保留接口，暂不实现）
FULL_ARCH = {
    "use_gateway": True,            # 使用Nginx网关 [保留接口]
    "use_vector_db": True,          # 使用Chroma/FAISS [保留接口]
    "use_redis": True,              # 使用Redis缓存 [保留接口]
    "use_celery": True,             # 使用Celery任务队列 [保留接口]
    "static_files": "nginx",        # Nginx静态文件服务 [保留接口]
    "vector_store": "chroma",       # Chroma向量数据库 [保留接口]
    "cache": "redis",               # Redis缓存 [保留接口]
    "database": "postgresql"        # PostgreSQL数据库 [保留接口]
}
```

**接口兼容性**：
- 所有模块提供统一接口
- 完整架构的实现类已定义接口，暂不实现
- 未来扩展时只需实现具体类，无需修改调用代码

## 二、技术栈选择

### 2.1 前端技术栈

#### 推荐方案：React + TypeScript
- **框架**：React 18+
- **语言**：TypeScript
- **UI库**：Ant Design / Material-UI / Tailwind CSS
- **状态管理**：Zustand
- **路由**：React Router
- **HTTP客户端**：Axios
- **构建工具**：Vite
- **语音**：Web Speech API (AUDIO_MODE控制)

### 2.2 后端技术栈

#### 推荐方案：Python + FastAPI
- **框架**：FastAPI
- **语言**：Python 3.10+
- **异步**：asyncio / aiohttp
- **ORM**：SQLAlchemy (async)
- **数据库**：PostgreSQL (生产) / SQLite (开发)
- **缓存**：Redis (可选)
- **任务队列**：Celery (可选，用于异步任务)

### 2.3 AI/智能体技术栈

#### 智能体框架
- **框架**：LangGraph
- **范式**：ReAct (Reasoning + Acting)
- **模块**：`src/backend/app/core/agent/` - 基于LangGraph的智能体框架
- **特点**：
  - 状态图管理
  - 工具调用
  - 循环推理
  - 可扩展节点

#### LLM集成
- **方案**：多模型支持 (OpenAI + 本地)
- **模块**：`src/backend/app/core/llmapi/` - 独立LLM接入模块
- **支持**：OpenAI API (GPT-4/GPT-3.5) + 本地模型降级

#### ASR (语音识别)
- **模块**：`src/backend/app/core/asr/` - 独立ASR接入模块
- **支持**：
  - OpenAI Whisper API
  - 本地Whisper模型
  - 其他ASR服务（可选）
- **接口**：统一ASR接口，可切换实现

#### TTS (文本转语音)
- **模块**：`src/backend/app/core/tts/` - 独立TTS接入模块
- **支持**：
  - OpenAI TTS API
  - 本地TTS模型（如pyttsx3, gTTS）
  - 其他TTS服务（可选）
- **接口**：统一TTS接口，可切换实现

#### 向量检索
- **工具**：Chroma / FAISS / Milvus（完整架构）
- **简化方案**：内存向量存储（验证阶段）
- **用途**：语义检索CSV和question.md内容
- **模块**：独立向量检索模块，支持切换实现

### 2.4 部署方案

#### 容器化
- **Docker**：应用容器化
- **Docker Compose**：本地开发环境
- **部署**：阿里云 + Docker容器化部署

#### 服务器配置

**简化架构（验证阶段）**：
- **应用服务器**：Uvicorn (FastAPI)
  - 内置静态文件服务
  - 单进程运行
  - 适合低并发（2-5用户）

**完整架构（生产环境）**：
- **Web服务器**：Nginx（可选，通过配置控制）
- **应用服务器**：Uvicorn (FastAPI)
- **进程管理**：Supervisor / systemd（可选）

## 三、模块化目录结构

```
project/
├── src/
│   ├── frontend/                    # 前端代码
│   │   ├── public/
│   │   ├── src/
│   │   │   ├── components/          # 组件
│   │   │   │   ├── StepGuide/       # 步骤引导组件
│   │   │   │   ├── QuestionCard/    # 问题卡片
│   │   │   │   ├── AnswerInput/     # 回答输入
│   │   │   │   ├── ChatInterface/   # 对话界面
│   │   │   │   ├── ProgressBar/     # 进度条
│   │   │   │   ├── FormulaDisplay/  # 公式展示
│   │   │   │   ├── GuideQuestions/  # 默认引导问题
│   │   │   │   └── UserProfile/     # 用户信息收集
│   │   │   ├── pages/               # 页面
│   │   │   │   ├── Home/            # 首页
│   │   │   │   ├── Register/        # 注册页
│   │   │   │   ├── Profile/         # 用户信息收集页
│   │   │   │   ├── Explore/         # 探索流程页
│   │   │   │   └── Result/          # 结果页
│   │   │   ├── stores/              # 状态管理
│   │   │   ├── services/            # API服务
│   │   │   ├── utils/               # 工具函数
│   │   │   └── types/               # TypeScript类型
│   │   ├── package.json
│   │   └── vite.config.ts
│   │
│   ├── backend/                     # 后端代码
│   │   ├── app/
│   │   │   ├── api/                 # API路由层
│   │   │   │   ├── v1/
│   │   │   │   │   ├── auth.py          # 认证（注册/登录）
│   │   │   │   │   ├── users.py         # 用户管理
│   │   │   │   │   ├── sessions.py      # 会话管理
│   │   │   │   │   ├── questions.py     # 问题相关
│   │   │   │   │   ├── answers.py       # 回答相关
│   │   │   │   │   ├── chat.py          # 对话接口
│   │   │   │   │   ├── progress.py      # 进度管理
│   │   │   │   │   ├── search.py        # 内容检索
│   │   │   │   │   └── export.py        # 导出功能
│   │   │   │   └── middleware.py        # 中间件
│   │   │   │
│   │   │   ├── core/                # 核心功能模块
│   │   │   │   ├── agent/               # 智能体框架 (LangGraph)
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── graph.py         # LangGraph状态图定义
│   │   │   │   │   ├── nodes/           # 图节点
│   │   │   │   │   │   ├── __init__.py
│   │   │   │   │   │   ├── reasoning.py # 推理节点
│   │   │   │   │   │   ├── action.py    # 行动节点
│   │   │   │   │   │   ├── observation.py # 观察节点
│   │   │   │   │   │   └── guide.py     # 引导节点
│   │   │   │   │   ├── edges.py         # 边定义
│   │   │   │   │   ├── state.py         # 状态定义
│   │   │   │   │   ├── context.py       # 上下文管理
│   │   │   │   │   └── react.py         # ReAct范式实现
│   │   │   │   ├── llmapi/              # LLM接入模块
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── api.py           # LLM API接口
│   │   │   │   │   ├── providers/       # 不同LLM提供商
│   │   │   │   │   │   ├── openai.py
│   │   │   │   │   │   └── local.py
│   │   │   │   │   └── prompt/          # 提示词管理
│   │   │   │   │       ├── templates.py
│   │   │   │   │       └── compressor.py # 提示词压缩
│   │   │   │   ├── asr/                 # ASR接入模块
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── api.py           # ASR API接口
│   │   │   │   │   ├── providers/       # 不同ASR提供商
│   │   │   │   │   │   ├── openai_whisper.py
│   │   │   │   │   │   ├── local_whisper.py
│   │   │   │   │   │   └── web_speech.py # 前端Web Speech API
│   │   │   │   │   └── processors/      # 音频处理
│   │   │   │   │       └── audio_utils.py
│   │   │   │   ├── tts/                 # TTS接入模块
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── api.py           # TTS API接口
│   │   │   │   │   ├── providers/       # 不同TTS提供商
│   │   │   │   │   │   ├── openai_tts.py
│   │   │   │   │   │   ├── pyttsx3.py
│   │   │   │   │   │   └── gtts.py
│   │   │   │   │   └── processors/      # 音频处理
│   │   │   │   │       └── audio_utils.py
│   │   │   │   ├── knowledge/           # 知识库模块
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── loader.py        # 知识库加载
│   │   │   │   │   ├── search.py        # 知识检索（统一接口）
│   │   │   │   │   ├── vector/          # 向量检索
│   │   │   │   │   │   ├── __init__.py
│   │   │   │   │   │   ├── base.py      # 向量存储基类
│   │   │   │   │   │   ├── memory.py    # 内存向量存储（简化架构）
│   │   │   │   │   │   ├── chroma.py    # Chroma实现（完整架构）
│   │   │   │   │   │   ├── faiss.py     # FAISS实现（完整架构）
│   │   │   │   │   │   └── embedder.py  # 向量嵌入
│   │   │   │   │   └── keyword/         # 关键词检索
│   │   │   │   │       └── matcher.py
│   │   │   │   ├── database/            # 数据库模块
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── connection.py    # 数据库连接（支持SQLite/PostgreSQL切换）
│   │   │   │   │   ├── user_db.py       # 用户数据
│   │   │   │   │   ├── history_db.py    # 历史数据
│   │   │   │   │   ├── knowledge_db.py  # 知识数据
│   │   │   │   │   └── vector_db.py     # 向量数据（可选，完整架构使用）
│   │   │   │   ├── async_service/       # 异步控制服务
│   │   │   │   │   ├── __init__.py
│   │   │   │   │   ├── base.py          # 异步服务基类
│   │   │   │   │   ├── simple_queue.py # 简单内存队列（简化架构）
│   │   │   │   │   ├── celery_queue.py  # Celery队列（完整架构）
│   │   │   │   │   ├── scheduler.py     # 调度器
│   │   │   │   │   └── worker.py        # 工作进程
│   │   │   │   └── tools/               # Tools模块
│   │   │   │       ├── __init__.py
│   │   │   │       ├── base.py          # 工具基类
│   │   │   │       ├── search_tool.py
│   │   │   │       ├── guide_tool.py
│   │   │   │       └── export_tool.py
│   │   │   │
│   │   │   ├── actions/             # Actions模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── base.py          # 动作基类
│   │   │   │   ├── answer_action.py
│   │   │   │   ├── guide_action.py
│   │   │   │   └── search_action.py
│   │   │   │
│   │   │   ├── skills/              # Skills模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── base.py          # 技能基类
│   │   │   │   ├── concept_explain.py
│   │   │   │   ├── question_guide.py
│   │   │   │   └── example_recommend.py
│   │   │   │
│   │   │   ├── models/             # 数据模型
│   │   │   │   ├── database.py     # 数据库配置
│   │   │   │   ├── user.py         # 用户模型
│   │   │   │   ├── session.py      # 会话模型
│   │   │   │   ├── conversation.py # 对话模型
│   │   │   │   ├── progress.py     # 进度模型
│   │   │   │   └── answer.py       # 回答模型
│   │   │   │
│   │   │   ├── services/           # 业务逻辑层
│   │   │   │   ├── auth_service.py
│   │   │   │   ├── user_service.py
│   │   │   │   ├── question_service.py
│   │   │   │   ├── answer_service.py
│   │   │   │   ├── search_service.py
│   │   │   │   └── export_service.py
│   │   │   │
│   │   │   ├── config/             # 配置模块
│   │   │   │   ├── settings.py    # 应用配置
│   │   │   │   ├── architecture.py # 架构配置（简单/完整）
│   │   │   │   ├── guide_config.py # 引导策略配置
│   │   │   │   └── audio_config.py # 语音配置
│   │   │   │
│   │   │   └── main.py             # 应用入口
│   │   │
│   │   ├── requirements.txt
│   │   └── Dockerfile
│   │
│   ├── knowledge/                   # 知识库
│   │   ├── csv/
│   │   │   ├── 重要的事_价值观.csv
│   │   │   ├── 擅长的事_才能.csv
│   │   │   └── 喜欢的事_热情.csv
│   │   ├── questions/
│   │   │   └── question.md
│   │   └── docs/
│   │       ├── note_organized.md
│   │       └── flowchart.md
│   │
│   └── shared/                      # 共享代码
│       └── types/                   # 类型定义
│
├── planning/                         # 设计文档
├── docker-compose.yml               # Docker编排
├── .env.example                     # 环境变量示例
└── README.md                        # 项目说明
```

## 四、模块设计说明

### 4.1 智能体框架 (`src/backend/app/core/agent/`) - LangGraph

**职责**：
- 基于LangGraph的智能体框架
- ReAct范式实现
- 状态图管理
- 工具调用和循环推理

**组件**：
- `graph.py`: LangGraph状态图定义
- `nodes/`: 图节点（推理、行动、观察、引导）
- `edges.py`: 边定义（条件路由）
- `state.py`: 状态定义（TypedDict）
- `react.py`: ReAct范式实现
- `context.py`: 上下文管理（可扩展算法）

**ReAct流程**：
```
思考(Thought) → 行动(Action) → 观察(Observation) → 思考(Thought) → ...
```

**LangGraph状态图示例**：
```python
# 状态定义
class AgentState(TypedDict):
    messages: List[Message]
    context: Dict
    current_step: str
    tools_used: List[str]

# 节点
def reasoning_node(state: AgentState) -> AgentState:
    # 推理节点
    pass

def action_node(state: AgentState) -> AgentState:
    # 行动节点（调用工具）
    pass

def observation_node(state: AgentState) -> AgentState:
    # 观察节点（获取工具结果）
    pass

# 构建图
graph = StateGraph(AgentState)
graph.add_node("reasoning", reasoning_node)
graph.add_node("action", action_node)
graph.add_node("observation", observation_node)
graph.add_edge("reasoning", "action")
graph.add_edge("action", "observation")
graph.add_conditional_edges("observation", should_continue)
```

### 4.2 LLM接入模块 (`src/backend/app/core/llmapi/`)

**职责**：
- 统一LLM API接口
- 支持多提供商（OpenAI、本地模型）
- 降级策略
- 提示词管理

**接口**：
```python
class LLMAPI:
    async def chat(messages: List[Message], **kwargs) -> Response
    async def stream_chat(messages: List[Message], **kwargs) -> AsyncIterator
```

### 4.3 ASR接入模块 (`src/backend/app/core/asr/`)

**职责**：
- 统一ASR API接口
- 支持多提供商（OpenAI Whisper、本地Whisper、Web Speech API）
- 音频格式处理

**接口**：
```python
class ASRAPI:
    async def transcribe(audio: bytes, language: str = "zh") -> str
    async def transcribe_file(file_path: str, language: str = "zh") -> str
```

**提供商**：
- `openai_whisper.py`: OpenAI Whisper API
- `local_whisper.py`: 本地Whisper模型
- `web_speech.py`: 前端Web Speech API（客户端处理）

### 4.4 TTS接入模块 (`src/backend/app/core/tts/`)

**职责**：
- 统一TTS API接口
- 支持多提供商（OpenAI TTS、本地TTS）
- 音频生成和格式处理

**接口**：
```python
class TTSAPI:
    async def synthesize(text: str, voice: str = "alloy") -> bytes
    async def synthesize_to_file(text: str, output_path: str, voice: str = "alloy") -> str
```

**提供商**：
- `openai_tts.py`: OpenAI TTS API
- `pyttsx3.py`: 本地pyttsx3（离线）
- `gtts.py`: Google TTS（在线）

### 4.5 知识检索模块 (`src/backend/app/core/knowledge/`)

**职责**：
- 知识库加载
- 关键词检索
- 向量检索（支持简单/完整架构切换）
- 结果排序

**组件**：
- `loader.py`: 加载CSV和Markdown
- `search.py`: 统一检索接口（自动选择实现）
- `vector/`: 向量检索实现
  - `base.py`: 向量存储基类
  - `memory.py`: 内存向量存储（简化架构）
  - `chroma.py`: Chroma实现（完整架构）
  - `faiss.py`: FAISS实现（完整架构）
- `keyword/`: 关键词匹配

**架构切换**：
```python
# 根据ARCHITECTURE_MODE自动选择
if ARCHITECTURE_MODE == "simple":
    vector_store = MemoryVectorStore()
else:
    vector_store = ChromaVectorStore()
```

### 4.6 数据库模块 (`src/backend/app/core/database/`)

**职责**：
- 数据库连接管理（支持SQLite/PostgreSQL切换）
- 用户数据操作
- 历史数据操作
- 知识数据操作
- 向量数据操作（可选，完整架构使用）

**分离**：
- `connection.py`: 数据库连接（根据配置选择SQLite或PostgreSQL）
- `user_db.py`: 用户注册、登录、个人信息
- `history_db.py`: 会话、对话、回答历史
- `knowledge_db.py`: 知识库缓存
- `vector_db.py`: 向量数据存储（可选）

**架构切换**：
```python
# 根据ARCHITECTURE_MODE自动选择
if ARCHITECTURE_MODE == "simple":
    DATABASE_URL = "sqlite:///./app.db"
else:
    DATABASE_URL = "postgresql://user:pass@localhost/db"
```

### 4.7 异步控制服务 (`src/backend/app/core/async_service/`)

**职责**：
- 异步任务队列（支持简单/完整架构切换）
- 任务调度
- 后台工作进程

**组件**：
- `base.py`: 异步服务基类
- `simple_queue.py`: 简单内存队列（简化架构）
- `celery_queue.py`: Celery队列（完整架构）

**架构切换**：
```python
# 根据ARCHITECTURE_MODE自动选择
if ARCHITECTURE_MODE == "simple":
    task_queue = SimpleMemoryQueue()
else:
    task_queue = CeleryQueue()
```

**用途**：
- 长时间任务（导出PDF）
- 批量处理
- 定时任务（清理过期数据）

### 4.6 Tools模块 (`src/backend/app/core/tools/`)

**职责**：
- 工具定义
- 工具注册
- 工具调用

**工具类型**：
- 搜索工具
- 引导工具
- 导出工具

### 4.7 Actions模块 (`src/backend/app/core/actions/`)

**职责**：
- 动作定义
- 动作执行
- 动作结果处理

**动作类型**：
- 回答动作
- 引导动作
- 搜索动作

### 4.8 Skills模块 (`src/backend/app/core/skills/`)

**职责**：
- 技能定义
- 技能组合
- 技能执行

**技能类型**：
- 概念解释技能
- 问题引导技能
- 示例推荐技能

## 五、配置管理

### 5.1 架构配置

```python
# config/architecture.py
ARCHITECTURE_MODE = "simple"  # "simple" | "full"

# 简化架构（验证阶段）
SIMPLE_ARCH = {
    "use_gateway": False,           # 不使用Nginx网关
    "use_vector_db": False,         # 不使用Chroma/FAISS
    "use_redis": False,             # 不使用Redis
    "use_celery": False,            # 不使用Celery
    "static_files": "fastapi",      # FastAPI内置静态文件服务
    "vector_store": "memory",       # 内存向量存储
    "cache": "memory",              # 内存缓存
    "database": "sqlite",           # SQLite数据库
    "task_queue": "memory"          # 内存任务队列
}

# 完整架构（生产环境）
FULL_ARCH = {
    "use_gateway": True,            # 使用Nginx网关
    "use_vector_db": True,          # 使用Chroma/FAISS
    "use_redis": True,              # 使用Redis缓存
    "use_celery": True,             # 使用Celery任务队列
    "static_files": "nginx",        # Nginx静态文件服务
    "vector_store": "chroma",       # Chroma向量数据库
    "cache": "redis",               # Redis缓存
    "database": "postgresql",       # PostgreSQL数据库
    "task_queue": "celery"          # Celery任务队列
}
```

### 5.2 环境变量

```bash
# 架构配置
ARCHITECTURE_MODE=simple  # simple | full

# 应用配置
APP_ENV=development
DEBUG=True
SECRET_KEY=xxx

# 数据库（根据架构自动选择）
# 简化架构：SQLite
DATABASE_URL=sqlite:///./app.db
# 完整架构：PostgreSQL
# DATABASE_URL=postgresql://user:pass@localhost/db

# LLM配置
LLM_PROVIDER=openai
OPENAI_API_KEY=xxx
LLM_MODEL=gpt-4

# ASR配置
ASR_PROVIDER=openai  # openai | local | web_speech
OPENAI_WHISPER_API_KEY=xxx

# TTS配置
TTS_PROVIDER=openai  # openai | pyttsx3 | gtts
OPENAI_TTS_API_KEY=xxx

# 语音功能
AUDIO_MODE=False

# 向量数据库（完整架构使用）
VECTOR_STORE=chroma  # chroma | faiss | memory
CHROMA_PERSIST_DIR=./chroma_db

# 缓存（完整架构使用）
REDIS_URL=redis://localhost:6379

# 引导策略
GUIDE_IDLE_TIMEOUT=600  # 10分钟（秒）
GUIDE_QUIET_TIMEOUT=900  # 15分钟（秒）
GUIDE_SHORT_ANSWER_THRESHOLD=20  # 字数阈值
```

### 5.3 引导策略配置

```python
# config/guide_config.py
GUIDE_STRATEGIES = {
    "idle_timeout": {
        "enabled": True,
        "timeout": 600,  # 10分钟
        "quiet_timeout": 900,  # 15分钟（用户要求安静时）
    },
    "short_answer": {
        "enabled": True,
        "threshold": 20,
        "action": "passive_guide"
    },
    "vague_answer": {
        "enabled": True,
        "action": "passive_guide"
    },
    "stuck": {
        "enabled": True,
        "timeout": 600,
        "action": "passive_guide"
    }
}
```

## 六、关键技术决策

### 6.1 架构选择策略
- **验证阶段**：使用简化架构（simple）
  - 无外部依赖（Nginx、Chroma、Redis、Celery）
  - 内存存储和缓存
  - SQLite数据库
  - FastAPI内置静态文件服务
- **生产环境**：使用完整架构（full）
  - 所有外部依赖可选
  - 通过配置控制启用
- **切换方式**：全局配置参数 `ARCHITECTURE_MODE`

### 6.2 智能体框架选择
- **框架**：LangGraph
- **范式**：ReAct (Reasoning + Acting)
- **优势**：
  - 成熟的状态图管理
  - 清晰的工具调用机制
  - 支持循环推理
  - 易于扩展节点和边

### 6.3 模块解耦原则
- **接口优先**：模块间通过接口通信
- **依赖注入**：减少硬编码依赖
- **配置驱动**：通过配置控制功能开关和架构选择
- **可扩展性**：保留扩展点，支持简单/完整架构切换

### 6.4 外部依赖管理
- **原则**：验证阶段尽可能减少外部依赖
- **策略**：
  - 所有外部依赖通过配置控制
  - 提供简单实现和完整实现两种选择
  - 保留接口和思路，后续可扩展
- **外部依赖列表**：
  - Nginx（网关）：可选，简化架构不使用
  - Chroma/FAISS（向量数据库）：可选，简化架构使用内存存储
  - Redis（缓存）：可选，简化架构使用内存缓存
  - Celery（任务队列）：可选，简化架构使用内存队列

### 6.5 上下文管理
- **当前实现**：直接拼接上下文全部内容
- **扩展点**：`context.py`中保留方法接口
- **未来优化**：可替换算法实现

### 6.6 性能优化
- **低并发**：2-5用户，无需复杂优化
- **缓存策略**：知识库内容缓存（内存/Redis）
- **异步处理**：长时间任务异步执行（内存队列/Celery）

### 6.7 安全性
- **HTTPS**：必须（生产环境）
- **JWT认证**：用户登录认证
- **数据加密**：敏感数据加密存储
- **CORS**：配置允许的前端域名

## 七、开发环境

### 7.1 本地开发（简化架构）

```bash
# 前端
cd src/frontend
npm install
npm run dev

# 后端（简化架构，无外部依赖）
cd src/backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements-core.txt

# 设置环境变量
export ARCHITECTURE_MODE=simple
export DATABASE_URL=sqlite:///./app.db
export AUDIO_MODE=False

# 启动服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 7.2 本地开发（完整架构）

```bash
# 需要启动外部服务
# 1. PostgreSQL
docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=pass postgres

# 2. Redis（可选）
docker run -d -p 6379:6379 redis

# 3. Chroma（可选）
docker run -d -p 8000:8000 chromadb/chroma

# 设置环境变量
export ARCHITECTURE_MODE=full
export DATABASE_URL=postgresql://user:pass@localhost/db
export REDIS_URL=redis://localhost:6379
export CHROMA_URL=http://localhost:8000

# 安装完整依赖
pip install -r requirements-full.txt

# 启动服务
uvicorn app.main:app --reload
```

### 7.3 Docker开发

```bash
# 简化架构（无外部依赖）
docker-compose -f docker-compose.simple.yml up -d

# 完整架构（包含所有服务）
docker-compose -f docker-compose.full.yml up -d
```

### 7.4 部署（阿里云）

```bash
# 构建镜像
docker build -t career-guide:latest .

# 运行容器（简化架构）
docker run -d \
  -p 80:8000 \
  -p 443:8443 \
  -e ARCHITECTURE_MODE=simple \
  -e DATABASE_URL=sqlite:///./app.db \
  career-guide:latest

# 运行容器（完整架构）
docker run -d \
  -p 80:8000 \
  -p 443:8443 \
  -e ARCHITECTURE_MODE=full \
  -e DATABASE_URL=postgresql://... \
  --link postgres:postgres \
  --link redis:redis \
  career-guide:latest
```

## 八、依赖管理

### 8.1 核心依赖（必需）

```txt
# requirements-core.txt
# 后端核心
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
sqlalchemy>=2.0.0
pydantic>=2.0.0
python-jose[cryptography]>=3.3.0
passlib[bcrypt]>=1.7.4
python-multipart>=0.0.6

# 智能体框架
langgraph>=0.0.20
langchain>=0.1.0

# LLM
openai>=1.0.0

# ASR/TTS（可选，AUDIO_MODE控制）
openai-whisper>=20231117  # 本地Whisper
pyttsx3>=2.90  # 本地TTS
gtts>=2.5.0  # Google TTS
```

### 8.2 可选依赖（完整架构）

```txt
# requirements-full.txt
# 包含 requirements-core.txt 的所有依赖

# 向量数据库
chromadb>=0.4.0  # Chroma
faiss-cpu>=1.7.4  # FAISS

# 缓存
redis>=5.0.0

# 任务队列
celery>=5.3.0

# 数据库
psycopg2-binary>=2.9.0  # PostgreSQL
```

### 8.3 依赖安装策略

```bash
# 核心依赖（必需）
pip install -r requirements-core.txt

# 完整架构依赖（可选）
if [ "$ARCHITECTURE_MODE" = "full" ]; then
    pip install -r requirements-full.txt
fi
```
